#ifndef RENDER_DX11_DRIVER_SHADER_STAGE_SHARED_HEADER
#define RENDER_DX11_DRIVER_SHADER_STAGE_SHARED_HEADER

#include <D3Dcommon.h>
#include <D3DX11async.h>

#include <stl/hash_map>
#include <stl/vector>

#include <xtl/bind.h>
#include <xtl/function.h>
#include <xtl/intrusive_ptr.h>
#include <xtl/ref.h>
#include <xtl/shared_ptr.h>

#include <common/file.h>
#include <common/hash.h>
#include <common/string.h>
#include <common/strlib.h>

#include <shared/error.h>
#include <shared/log.h>
#include <shared/shader_manager.h>

namespace render
{

namespace low_level
{

namespace dx11
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип шейдера
///////////////////////////////////////////////////////////////////////////////////////////////////
enum ShaderType
{
  ShaderType_Compute,
  ShaderType_Domain,
  ShaderType_Geometry,
  ShaderType_Hull,
  ShaderType_Pixel,
  ShaderType_Vertex,

  ShaderType_Num
};

typedef xtl::shared_ptr<ShaderCode> ShaderCodePtr;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Шейдер
///////////////////////////////////////////////////////////////////////////////////////////////////
class Shader: public DeviceObject
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    Shader  (ShaderType shader_type, const ShaderCodePtr& shader_code);
    ~Shader ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип шейдера
///////////////////////////////////////////////////////////////////////////////////////////////////
    ShaderType GetType () const { return type; }

///////////////////////////////////////////////////////////////////////////////////////////////////
///Объект шейдера
///////////////////////////////////////////////////////////////////////////////////////////////////
    ID3D11DeviceChild& GetHandle () const { return *shader; }

///////////////////////////////////////////////////////////////////////////////////////////////////
///Код шейдера
///////////////////////////////////////////////////////////////////////////////////////////////////
    ShaderCode& GetShaderCode () const { return *code; }

  private:
    ShaderType       type;   //тип шейдера
    DxDeviceChildPtr shader; //объект шейдера
    ShaderCodePtr    code;   //код шейдера
};

typedef xtl::com_ptr<Shader> ShaderPtr;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Библиотека шейдеров
///////////////////////////////////////////////////////////////////////////////////////////////////
class ShaderLibrary: public DeviceObject
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    ShaderLibrary  (const DeviceManager& device_manager);
    ~ShaderLibrary ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание шейдера
///////////////////////////////////////////////////////////////////////////////////////////////////
    ShaderPtr CreateShader (const ShaderDesc& shader_desc, const LogFunction& error_log);

  private:
    void RemoveShaderByHash (size_t hash);

  private:
    typedef stl::hash_map<size_t, Shader*> ShaderMap;

  private:
    ShaderMap shaders; //шейдеры
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Программа
///////////////////////////////////////////////////////////////////////////////////////////////////
class Program: virtual public IProgram, public DeviceObject
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    Program  (ShaderLibrary& library, size_t shaders_count, const ShaderDesc* shader_descs, const LogFunction& error_log);
    ~Program ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка программы в контекст
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Bind (ID3D11DeviceContext& context);

  private:
    typedef stl::vector<ShaderPtr> ShaderList;    

  private:
    ShaderList            shaders;         //список использованных шейдеров    
    ID3D11ComputeShader*  compute_shader;  //вычислительный шейдер
    ID3D11DomainShader*   domain_shader;   //шейдер входного слоя
    ID3D11GeometryShader* geometry_shader; //геометрический шейдер
    ID3D11HullShader*     hull_shader;     //шейдер оболочки
    ID3D11PixelShader*    pixel_shader;    //пиксельный шейдер
    ID3D11VertexShader*   vertex_shader;   //вершинный шейдер
};

}

}

}

#endif
