#ifndef RENDER_DX11_DRIVER_RENDER_TARGET_MANAGER_SHARED_HEADER
#define RENDER_DX11_DRIVER_RENDER_TARGET_MANAGER_SHARED_HEADER

#include <xtl/trackable_ptr.h>

#include <common/hash.h>

#include <render/low_level/utils.h>

#include <shared/error.h>
#include <shared/render_target_manager.h>
#include <shared/swap_chain.h>
#include <shared/texture.h>

namespace render
{

namespace low_level
{

namespace dx11
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип отображения
///////////////////////////////////////////////////////////////////////////////////////////////////
enum ViewType
{
  ViewType_RenderTarget,
  ViewType_DepthStencil,
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Отображение
///////////////////////////////////////////////////////////////////////////////////////////////////
class View: virtual public IView, public DeviceObject
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    View  (const DeviceManager& device_manager, ITexture* texture, const ViewDesc& desc);
    ~View ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Низкоуровневый дескриптор
///////////////////////////////////////////////////////////////////////////////////////////////////
    ID3D11View& GetHandle () { return *view; }

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип отображения
///////////////////////////////////////////////////////////////////////////////////////////////////
    ViewType GetType () { return view_type; }

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение целевой текстуры
///////////////////////////////////////////////////////////////////////////////////////////////////
    ITexture* GetTexture ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение дескриптора / флагов биндинга текстуры
///////////////////////////////////////////////////////////////////////////////////////////////////
    void GetDesc (ViewDesc&);

  private:
    typedef xtl::com_ptr<ITexture> TexturePtr;

  private:
    TexturePtr texture;    //указатель на текстуру
    DxViewPtr  view;       //низкоуровневый дескриптор
    ViewType   view_type;  //тип отображения
    ViewDesc   desc;       //дескриптор отображения        
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Буфер рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
class RenderBuffer: public ITextureImpl
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    RenderBuffer (const DeviceManager& manager, const TextureDesc& desc, const DxTexture2DPtr& resource);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение дескриптора
///////////////////////////////////////////////////////////////////////////////////////////////////
    void GetDesc (TextureDesc&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение низкоуровневого дескриптора
///////////////////////////////////////////////////////////////////////////////////////////////////
    ID3D11Resource&           GetHandle             ();
    ID3D11ShaderResourceView& GetShaderResourceView ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение типа буфера
///////////////////////////////////////////////////////////////////////////////////////////////////
    ViewType GetViewType () const { return view_type; }

///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с данными
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SetData (size_t layer, size_t mip_level, size_t x, size_t y, size_t width, size_t height, PixelFormat source_format, const void* buffer);
    void GetData (size_t layer, size_t mip_level, size_t x, size_t y, size_t width, size_t height, PixelFormat target_format, void* buffer);

  private:
    ViewType       view_type;  //тип буфера
    TextureDesc    desc;       //дескриптор текстуры
    DxTexture2DPtr texture;    //ресурс
};

}

}

}

#endif
