///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание текстурной карты
///////////////////////////////////////////////////////////////////////////////////////////////////
struct TexmapDesc
{
  unsigned int channel;         //номер текстурного канала
  stl::string  semantic;        //имя семантики в media::rfx::Texmap
  stl::string  param_name;      //имя параметра в шейдере
  bool         is_framemap;     //является ли текстурная карта контекстной картой кадра
  size_t       semantic_hash;   //хеш имени семантики
  stl::string  default_sampler; //сэмплер по умолчанию
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Программа шейдинга
///////////////////////////////////////////////////////////////////////////////////////////////////
class Program: public Object, public CacheSource
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    Program  (const DeviceManagerPtr& device_manager, const TextureManagerPtr& texture_manager, const char* name, const char* static_options, const char* dynamic_options);
    ~Program ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя программы
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Шейдеры данной программы
///////////////////////////////////////////////////////////////////////////////////////////////////
    void         Attach           (const media::rfx::Shader&);
    void         Detach           (const media::rfx::Shader&);
    void         DetachAllShaders ();
    unsigned int ShadersCount     ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Опции данной программы
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* StaticOptions  ();
    const char* DynamicOptions ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Отображение семантики текстурной карты на номер канала и имя параметра
///////////////////////////////////////////////////////////////////////////////////////////////////
    unsigned int      TexmapsCount         ();
    bool              HasFramemaps         ();
    const TexmapDesc* Texmaps              ();
    const TexmapDesc& Texmap               (unsigned int index);
    const TexmapDesc* FindTexmapBySemantic (size_t semantic_hash);
    const TexmapDesc* FindTexmapBySemantic (const char* semantic);
    void              SetTexmap            (unsigned int index, unsigned int channel, const char* semantic, const char* param_name, const char* default_sampler, bool is_framemap = false);
    unsigned int      AddTexmap            (unsigned int channel, const char* semantic, const char* param_name, const char* default_sampler, bool is_framemap = false);
    void              RemoveTexmap         (unsigned int index);
    void              RemoveAllTexmaps     ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение производной программы
///////////////////////////////////////////////////////////////////////////////////////////////////
    Program& DerivedProgram (const ShaderOptions&);
    Program& DerivedProgram (ShaderOptionsCache&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение низкоуровневой программы шейдинга
///////////////////////////////////////////////////////////////////////////////////////////////////
    const LowLevelProgramPtr& LowLevelProgram ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Блок состояний программы
///////////////////////////////////////////////////////////////////////////////////////////////////
    LowLevelStateBlockPtr StateBlock ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение объекта расположения параметров программы шейдинга
///////////////////////////////////////////////////////////////////////////////////////////////////
    ProgramParametersLayoutPtr ParametersLayout ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Управление кэшированием
///////////////////////////////////////////////////////////////////////////////////////////////////
    using CacheSource::UpdateCache;
    using CacheSource::ResetCache;
    
  private:
    void UpdateCacheCore ();
    void ResetCacheCore ();

    Program (Program& parent, const ShaderOptions&);

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};
