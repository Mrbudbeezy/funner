///////////////////////////////////////////////////////////////////////////////////////////////////
///Буфер примитивов
///////////////////////////////////////////////////////////////////////////////////////////////////
class PrimitiveBuffersImpl: public Object
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    PrimitiveBuffersImpl  (const DeviceManagerPtr&);
    ~PrimitiveBuffersImpl ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Управление кэшем
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SetCacheState (bool state);
    bool CacheState    ();
    void EnableCache   () { SetCacheState (true); }
    void DisableCache  () { SetCacheState (false); }
    void FlushCache    ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание отображений буферов
///////////////////////////////////////////////////////////////////////////////////////////////////
    LowLevelBufferPtr CreateVertexStream (const media::geometry::VertexStream&, MeshBufferUsage usage);
    VertexBufferPtr   CreateVertexBuffer (const media::geometry::VertexBuffer&, MeshBufferUsage usage);
    LowLevelBufferPtr CreateIndexBuffer  (const media::geometry::IndexBuffer&, MeshBufferUsage usage);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление буферов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Add (const media::geometry::VertexStream& buffer, MeshBufferUsage usage = MeshBufferUsage_Default);
    void Add (const media::geometry::VertexBuffer& buffer, MeshBufferUsage usage = MeshBufferUsage_Default);    
    void Add (const media::geometry::IndexBuffer& buffer, MeshBufferUsage usage = MeshBufferUsage_Default);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление буферов
///////////////////////////////////////////////////////////////////////////////////////////////////    
    void Update (const media::geometry::VertexStream& buffer);
    void Update (const media::geometry::IndexBuffer& buffer);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Удаление буферов
///////////////////////////////////////////////////////////////////////////////////////////////////        
    void Remove    (const media::geometry::VertexStream& buffer);
    void Remove    (const media::geometry::VertexBuffer& buffer);    
    void Remove    (const media::geometry::IndexBuffer& buffer);
    void RemoveAll ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Резервирование вспомогательных примитивов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   ReserveDynamicPrimitives (size_t sprites_count, size_t lines_count);
    size_t LinesCapacity            ();
    size_t SpritesCapacity          ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Динамические буферы
///////////////////////////////////////////////////////////////////////////////////////////////////
    manager::DynamicVertexBuffer& DynamicVertexBuffer ();
    manager::DynamicIndexBuffer&  DynamicIndexBuffer  ();

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};
