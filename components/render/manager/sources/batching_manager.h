class BatchingManager;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Блок состояний пакета
///////////////////////////////////////////////////////////////////////////////////////////////////
class BatchStateBlock: public Object, public CacheSource
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    BatchStateBlock  (BatchingManager& batching_manager, MaterialImpl& material);
    ~BatchStateBlock ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Блок состояний
///////////////////////////////////////////////////////////////////////////////////////////////////
    LowLevelStateBlockPtr StateBlock ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Управление кэшированием
///////////////////////////////////////////////////////////////////////////////////////////////////
    using CacheSource::UpdateCache;
    using CacheSource::ResetCache;

  private:
    void UpdateCacheCore ();
    void ResetCacheCore ();

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер упаковки примитивов
///////////////////////////////////////////////////////////////////////////////////////////////////
class BatchingManager: public Object
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    BatchingManager  (const DeviceManagerPtr&);
    ~BatchingManager ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Ссылка на менеджер устройства
///////////////////////////////////////////////////////////////////////////////////////////////////
    manager::DeviceManager& DeviceManager ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Резервирование буферов для динамических примитивов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   ReserveDynamicBuffers (size_t vertices_count, size_t indices_count);
    size_t DynamicVerticesCount  () const;
    size_t DynamicIndicesCount   () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Динамические буферы
///////////////////////////////////////////////////////////////////////////////////////////////////
    manager::DynamicVertexBuffer& DynamicVertexBuffer ();
    manager::DynamicIndexBuffer&  DynamicIndexBuffer  ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Выделение вершин и индексов
///////////////////////////////////////////////////////////////////////////////////////////////////
    DynamicPrimitiveVertex* AllocateDynamicVertices (size_t count, size_t* out_base_vertex_index = 0);
    DynamicPrimitiveIndex*  AllocateDynamicIndices  (size_t count);
    void                    ResetDynamicBuffers     ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение блока состояний по материалу
///////////////////////////////////////////////////////////////////////////////////////////////////
    BatchStateBlockPtr GetStateBlock (MaterialImpl* material);

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};
