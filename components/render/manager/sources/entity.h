struct RendererPrimitive;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание операции рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
struct RendererOperation
{
  EntityImpl*                     entity;             //объект
  render::low_level::IStateBlock* entity_state_block; //блок состояний объекта
  const RendererPrimitive*        primitive;          //примитив
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание списка операций
///////////////////////////////////////////////////////////////////////////////////////////////////
struct RendererOperationList
{
  size_t                   operations_count; //количество операций
  const RendererOperation* operations;       //операции
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Объект рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
class EntityImpl: public Object
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    EntityImpl  (const DeviceManagerPtr&, const PrimitiveManagerPtr&);
    ~EntityImpl ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Свойства рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    void                       SetProperties (const common::PropertyMap&);
    const common::PropertyMap& Properties    ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Матрица преобразований
///////////////////////////////////////////////////////////////////////////////////////////////////
    void               SetTransformation (const math::mat4f&);
    const math::mat4f& Transformation    ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с костями (для скиннинга)
///  преобразования умножаются на матрицу Entity::Transformation в случае если она не единична
///////////////////////////////////////////////////////////////////////////////////////////////////
    void               SetJointsCount         (size_t count);
    size_t             JointsCount            ();
    void               SetJointTransformation (size_t joint_index, const math::mat4f&);
    const math::mat4f& JointTransformation    (size_t joint_index);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с уровнями детализации
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t LodsCount ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с примитивом
///////////////////////////////////////////////////////////////////////////////////////////////////
    PrimitivePtr Primitive           (size_t level_of_detail);
    const char*  PrimitiveName       (size_t level_of_detail);  
    void         SetPrimitive        (const PrimitivePtr&, size_t level_of_detail);
    void         SetPrimitive        (const char* name, size_t level_of_detail);
    void         ResetPrimitive      (size_t level_of_detail);
    bool         HasPrimitive        (size_t level_of_detail);
    void         ResetAllPrimitives  ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение операций рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    const RendererOperationList& RendererOperations (size_t level_of_detail);

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Хранилище текстур материала
///////////////////////////////////////////////////////////////////////////////////////////////////
class EntityTextureStorage: public xtl::noncopyable
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    EntityTextureStorage  (EntityImpl& entity);
    ~EntityTextureStorage ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Начало и конец обновления
///////////////////////////////////////////////////////////////////////////////////////////////////
    void BeginUpdate ();
    void EndUpdate   ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение текстур для материала
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t GetTextures (const MaterialPtr& material, TexturePtr textures [low_level::DEVICE_SAMPLER_SLOTS_COUNT]);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление текстур
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Update (const FramePtr& frame);
  
  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

