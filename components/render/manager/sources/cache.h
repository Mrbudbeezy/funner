#ifndef RENDER_MANAGER_CACHE_HEADER
#define RENDER_MANAGER_CACHE_HEADER

///////////////////////////////////////////////////////////////////////////////////////////////////
///Объект, хранящий кэшируемые объекты
///////////////////////////////////////////////////////////////////////////////////////////////////
class CacheHolder: public xtl::noncopyable
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    CacheHolder  ();
    ~CacheHolder ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Построение списка связанных хранителей кэша
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Attach    (CacheHolder&);
    void Detach    (CacheHolder&);
    void DetachAll ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Соответствует ли кэш источнику / является ли данный объект родительским по отношению к переданному
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool IsValid    () { return !need_update; }
    bool IsParentOf (CacheHolder& child);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Отметка о необходимости обновления кэша источника
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Invalidate ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление кэша. Необходимо вызывать перед каждым использованием ресурса
///////////////////////////////////////////////////////////////////////////////////////////////////
    void UpdateCache ();

  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Кэшируемый источник требует обновления кэша.
///////////////////////////////////////////////////////////////////////////////////////////////////  
    virtual void UpdateCacheCore () = 0;
    //TODO: ResetCacheCore

  private:
    typedef stl::list<CacheHolder*> HolderList;

  private:
    HolderList parent_holders;
    HolderList child_holders;
    bool       need_update;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Источник кэшированных данных
///////////////////////////////////////////////////////////////////////////////////////////////////
class CacheSource: private CacheHolder
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Построение списка связанных хранителей кэша
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Attach (CacheHolder&);
    void Detach (CacheHolder&);

  protected:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Отметка о необходимости обновления кэша
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Invalidate ();
    
  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Кэшируемый источник требует обновления кэша.
///////////////////////////////////////////////////////////////////////////////////////////////////  
    void UpdateCacheCore ();
};

#endif
