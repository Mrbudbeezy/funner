///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание примитива рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
template <class T> 
class DynamicPrimitiveBuffer
{
  public:
    typedef T Item;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    DynamicPrimitiveBuffer (low_level::BindFlag flags);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Низкроуровневый буфер
///////////////////////////////////////////////////////////////////////////////////////////////////
    const LowLevelBufferPtr& LowLevelBuffer () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Текущий размер буфера
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Size   () const;
    void   Resize (size_t size);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Максимальный размер буфера
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Capacity () const;
    void   Reserve  (size_t size);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение данных
///////////////////////////////////////////////////////////////////////////////////////////////////
          Item* Data ();
    const Item* Data () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка буфера
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Clear ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Синхронизация буферов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SyncBuffers (low_level::IDevice& device);

  private:
    typedef xtl::uninitialized_storage<Item> ItemBuffer;

  private:
    ItemBuffer          src_buffer;
    LowLevelBufferPtr   dst_buffer;
    size_t              dst_buffer_size;
    low_level::BindFlag bind_flags;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Синхронизация буферов
///////////////////////////////////////////////////////////////////////////////////////////////////
void sync_buffers (low_level::IDevice& device, low_level::BindFlag bind_flags, const void* src_data, size_t src_data_size, size_t& dst_buffer_size, LowLevelBufferPtr& dst_buffer);

/*
    Реализация
*/

template <class T>
inline DynamicPrimitiveBuffer<T>::DynamicPrimitiveBuffer (low_level::BindFlag flags)
  : dst_buffer_size ()
  , bind_flags (flags)
{
}

template <class T> 
inline const LowLevelBufferPtr& DynamicPrimitiveBuffer<T>::LowLevelBuffer () const
{
  return dst_buffer.get ();
}

template <class T> 
inline size_t DynamicPrimitiveBuffer<T>::Size () const
{
  return src_buffer.size ();
}

template <class T>
inline void DynamicPrimitiveBuffer<T>::Resize (size_t size)
{
  src_buffer.resize (size);
}

template <class T>
inline size_t DynamicPrimitiveBuffer<T>::Capacity () const
{
  return src_buffer.capacity ();
}

template <class T>
inline typename DynamicPrimitiveBuffer<T>::Item* DynamicPrimitiveBuffer<T>::Data ()
{
  return src_buffer.data ();
}

template <class T>
inline const typename DynamicPrimitiveBuffer<T>::Item* DynamicPrimitiveBuffer<T>::Data () const
{
  return src_buffer.data ();
}

template <class T>
inline void DynamicPrimitiveBuffer<T>::Clear ()
{
  src_buffer.resize (0, false);
}

template <class T>
inline void DynamicPrimitiveBuffer<T>::SyncBuffers (low_level::IDevice& device)
{
  sync_buffers (device, bind_flags, &src_buffer.data (), src_buffer.size () * sizeof (Item), dst_buffer_size, dst_buffer);  
}
