///////////////////////////////////////////////////////////////////////////////////////////////////
///Базовый класс кэша
///////////////////////////////////////////////////////////////////////////////////////////////////
class Cache: public xtl::noncopyable
{
  friend class CacheManager;
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    Cache  (const CacheManagerPtr&);
    ~Cache ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Текущий кадр / текущий фрейм
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t CurrentTime  () { return current_time; }    
    size_t CurrentFrame () { return current_frame; }
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Параметры кэширования
///////////////////////////////////////////////////////////////////////////////////////////////////    
    size_t TimeDelay  ();
    size_t FrameDelay ();

  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Сброс закэшированных элементов
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual void FlushCache () = 0;
    
  private:
    CacheManagerPtr manager;
    size_t          current_time;
    size_t          current_frame;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер кэширования
///////////////////////////////////////////////////////////////////////////////////////////////////
class CacheManager: public Object
{
  friend class Cache;
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    CacheManager  ();
    ~CacheManager ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Параметры кэширования
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   SetTimeDelay  (size_t milliseconds);
    void   SetFrameDelay (size_t frames_count);
    size_t TimeDelay     ();
    size_t FrameDelay    ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление маркеров времени
///////////////////////////////////////////////////////////////////////////////////////////////////
    void UpdateMarkers ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Сброс кэшей
///////////////////////////////////////////////////////////////////////////////////////////////////
    void FlushCaches ();
    
  private:
    void AddCache    (Cache&);
    void RemoveCache (Cache&);

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};
