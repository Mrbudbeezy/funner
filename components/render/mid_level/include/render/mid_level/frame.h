#ifndef RENDER_MID_LEVEL_FRAME_HEADER
#define RENDER_MID_LEVEL_FRAME_HEADER

#include <math/matrix.h>

#include <render/mid_level/common.h>
#include <render/mid_level/entity.h>
#include <render/mid_level/render_target.h>

namespace render
{

namespace mid_level
{

//implementation forwards
class FrameImpl;
class Wrappers;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Флаги очистки
///////////////////////////////////////////////////////////////////////////////////////////////////
enum ClearFlag
{
  ClearFlag_RenderTarget  = 1, //очистка буфера цвета
  ClearFlag_Depth         = 2, //очистка буфера глубины
  ClearFlag_Stencil       = 4, //очистка буфера трафарета
  ClearFlag_ViewportOnly  = 8, //очистка только области вывода (могут быть потери производительности)

  ClearFlag_DepthStencil = ClearFlag_Depth | ClearFlag_Stencil,
  ClearFlag_All          = ClearFlag_DepthStencil | ClearFlag_RenderTarget
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Порядок кадров
///////////////////////////////////////////////////////////////////////////////////////////////////
enum FrameOrder
{
  FrameOrder_PreRender,  //кадр рисуется до основного и до всех его дочерних кадров
  FrameOrder_Child,      //дочерний кадр
  FrameOrder_PostRender, //кадр рисуется после основного и всех его дочерних кадров
  
  FrameOrder_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Визуализируемый кадр
///////////////////////////////////////////////////////////////////////////////////////////////////
class Frame
{
  friend class Wrappers;
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    Frame  (const Frame&);
    ~Frame ();

    Frame& operator = (const Frame&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Целевые буферы отрисовки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void                          SetRenderTargets   (const mid_level::RenderTarget& render_target, const mid_level::RenderTarget& depth_stencil_target);
          mid_level::RenderTarget RenderTarget       ();
          mid_level::RenderTarget DepthStencilTarget ();
    const mid_level::RenderTarget RenderTarget       () const;
    const mid_level::RenderTarget DepthStencilTarget () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Область вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetViewport (const Rect&);
    const Rect& Viewport    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Область отсечения
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetScissor      (const Rect&);
    const Rect& Scissor         () const;
    void        SetScissorState (bool state);
    bool        ScissorState    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Флаги очистки кадра
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   SetClearFlags (size_t clear_flags);
    size_t ClearFlags    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Параметры очистки буфера цвета
///////////////////////////////////////////////////////////////////////////////////////////////////
    void               SetClearColor (const math::vec4f& color);
    const math::vec4f& ClearColor    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Параметры очистки буфера попиксельного отсечения
///////////////////////////////////////////////////////////////////////////////////////////////////
    void          SetClearDepthValue   (float depth_value);
    void          SetClearStencilIndex (unsigned char stencil_index);
    float         ClearDepthValue   ();
    unsigned char ClearStencilIndex ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Матрица вида / матрица преобразования
///////////////////////////////////////////////////////////////////////////////////////////////////
    void               SetViewMatrix       (const math::mat4f&);
    void               SetProjectionMatrix (const math::mat4f&);
    const math::mat4f& ViewMatrix          () const;
    const math::mat4f& ProjectionMatrix    () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка техники рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetTechnique (const char* name);
    const char* Technique    () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Свойства рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    void                       SetProperties (const common::PropertyMap&);
    const common::PropertyMap& Properties    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Список отрисовки
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t EntitiesCount     () const;
    void   AddEntity         (const Entity&);
    void   RemoveAllEntities ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление пре-рендеринга и пост-рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    void AddFrame        (FrameOrder order, const Frame& frame);
    void RemoveAllFrames ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание кадров и добавление их к данному
///////////////////////////////////////////////////////////////////////////////////////////////////
    Frame AddPreRenderFrame  ();
    Frame AddChildFrame      ();
    Frame AddPostRenderFrame ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Удаление всех объектов из кадра
///////////////////////////////////////////////////////////////////////////////////////////////////
    void RemoveAll ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Рисование кадра
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Draw ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (Frame&);
    
  private:
    Frame (FrameImpl*);
    
  private:
    FrameImpl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (Frame&, Frame&);

}

}

#endif
