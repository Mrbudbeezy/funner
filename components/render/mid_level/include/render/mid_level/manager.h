#ifndef RENDER_MID_LEVEL_MANAGER_HEADER
#define RENDER_MID_LEVEL_MANAGER_HEADER

#include <render/mid_level/resource_library.h>
#include <render/mid_level/window.h>
#include <render/mid_level/entity.h>
#include <render/mid_level/material.h>
#include <render/mid_level/texture.h>
#include <render/mid_level/dynamic_resource.h>

///???экспортируемые свойства рендеринга из материалов через entity
///???техники и entity

namespace render
{

namespace mid_level
{

//implementation forwards
class RenderManagerImpl;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Оконные события менеджера рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
enum RenderManagerWindowEvent
{
  RenderManagerWindowEvent_OnAdded,   //добавлено новое окно рендеринга
  RenderManagerWindowEvent_OnRemoved, //удалено окно рендеринга
  
  RenderManagerWindowEvent_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Режим использования создаваемых ресурсов
///////////////////////////////////////////////////////////////////////////////////////////////////
enum ResourceInstanceMode
{
  ResourceInstanceMode_Shared, //ресурс используется совместно
  ResourceInstanceMode_Copy,   //ресурс копируется при создании

  ResourceInstanceMode_Default = ResourceInstanceMode_Shared
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
class RenderManager
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    RenderManager  ();
    RenderManager  (const RenderManager&);
    ~RenderManager ();
    
    RenderManager& operator = (const RenderManager&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Строка описания устройства рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Description () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание окна рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    Window CreateWindow (syslib::Window& window, common::PropertyMap& properties);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Перебор окон рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t       WindowsCount () const;
    const Window Window       (size_t index) const;
          Window Window       (size_t index);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание целей рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    RenderTarget CreateRenderBuffer       (size_t width, size_t height, PixelFormat format);
    RenderTarget CreateDepthStencilBuffer (size_t width, size_t height);
                                                         
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание примитивов
///////////////////////////////////////////////////////////////////////////////////////////////////
    Primitive CreatePrimitive      ();
    Primitive CreatePrimitive      (const char* name, ResourceInstanceMode mode = ResourceInstanceMode_Default);
    Frame     CreateFrame          ();
    Texture   CreateTexture        (const media::Image& image);
    Texture   CreateTexture        (const media::Image& image, TextureDimension dimension);
    Texture   CreateTexture2D      (size_t width, size_t height, PixelFormat format);
    Texture   CreateTexture3D      (size_t width, size_t height, size_t depth, PixelFormat format);
    Texture   CreateTextureCubemap (size_t size, PixelFormat format);
    Material  CreateMaterial       ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка ресурсов
///////////////////////////////////////////////////////////////////////////////////////////////////
    ResourceLibrary Load (const char* resource_name);
    ResourceLibrary Load (const media::rfx::MaterialLibrary&);
    ResourceLibrary Load (const media::rfx::EffectLibrary&);
    ResourceLibrary Load (const media::geometry::MeshLibrary&);
    ResourceLibrary Load (const media::rfx::ShaderLibrary&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация на события
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (RenderManager& manager, Window& window)> WindowEventHandler;

    xtl::connection RegisterWindowEventHandler (RenderManagerWindowEvent event, const WindowEventHandler& handler) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (RenderManager&);
    
  private:
    RenderManagerImpl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (RenderManager&, RenderManager&);

}

}

#endif
