#ifndef RENDER_GL_DRIVER_RENDER_TARGET_MANAGER_HEADER
#define RENDER_GL_DRIVER_RENDER_TARGET_MANAGER_HEADER

#include <stl/auto_ptr.h>
#include <render/low_level/device.h>
#include <shared/stage_state.h>

namespace render
{

namespace low_level
{

namespace opengl
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер целевых буферов рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
class RenderTargetManager
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    RenderTargetManager  (const ContextManager&, ISwapChain* swap_chain);
    ~RenderTargetManager ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание объекта состояния уровня
///////////////////////////////////////////////////////////////////////////////////////////////////
    IStageState* CreateStageState ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание текстур
///////////////////////////////////////////////////////////////////////////////////////////////////
    ITexture* CreateTexture             (const TextureDesc&);
    ITexture* CreateRenderTargetTexture (ISwapChain* swap_chain, unsigned int buffer_index);
    ITexture* CreateDepthStencilTexture (ISwapChain* swap_chain);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание отображений
///////////////////////////////////////////////////////////////////////////////////////////////////
    IView* CreateView (ITexture* texture, const ViewDesc&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Выбор целевых отображений
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   SetRenderTargetView  (unsigned int render_target_slot, IView* render_target_view);
    void   SetDepthStencilView  (IView* depth_stencil_view);
    IView* GetRenderTargetView  (unsigned int render_target_slot) const;
    IView* GetDepthStencilView  () const;
    void   HasRenderTargetViews (bool states [DEVICE_RENDER_TARGET_SLOTS_COUNT]) const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Настройка подуровня растеризации
///////////////////////////////////////////////////////////////////////////////////////////////////
    void            SetViewport (unsigned int render_target_slot, const Viewport& viewport);
    void            SetScissor  (unsigned int render_target_slot, const Rect& scissor_rect);
    const Viewport& GetViewport (unsigned int render_target_slot) const;
    const Rect&     GetScissor  (unsigned int render_target_slot) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка буферов отрисовки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void ClearRenderTargetView (unsigned int render_target_slot, const Color4f& color);
    void ClearDepthStencilView (unsigned int clear_flags, float depth, unsigned char stencil);
    void ClearViews            (unsigned int clear_flags, unsigned int views_count, const unsigned int* view_indices, const Color4f* colors, float depth, unsigned char stencil);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление целевых буферов отрисовки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void UpdateRenderTargets ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка состояния уровня в контекст OpenGL
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Bind ();

  private:
    RenderTargetManager (const RenderTargetManager&); //no impl
    RenderTargetManager& operator = (const RenderTargetManager&); //no impl
  
  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

}

}

}

#endif
