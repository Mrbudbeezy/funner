#ifndef RENDER_SCENE_SERVER_VIEWPORT_MANAGER_SHARED_HEADER
#define RENDER_SCENE_SERVER_VIEWPORT_MANAGER_SHARED_HEADER

#include <stl/auto_ptr.h>

#include <render/scene/interchange/types.h>

#include <shared/render_target_map.h>

namespace render
{

namespace manager
{

//forward declarations
class Frame;

}

namespace scene
{

namespace server
{

//forward declarations
class Camera;
class Scene;
class ViewportDrawList;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Слушатель области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
class IViewportListener
{
  public:
    virtual void OnViewportZOrderUpdated (int zorder) = 0;

  protected:
    virtual ~IViewportListener () {}
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Область вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
class Viewport
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    Viewport  (const RenderManager& render_manager, const RenderTargetMap& render_target_map, const ViewportDrawList& viewports, size_t max_draw_depth);
    Viewport  (const Viewport&);
    ~Viewport ();

    Viewport& operator = (const Viewport&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetName (const char* name);
    const char* Name    () const;   

///////////////////////////////////////////////////////////////////////////////////////////////////
///Область
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetArea (const Rect&);
    const Rect& Area    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Диапазон глубины для области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    float MinDepth    () const;
    float MaxDepth    () const;
    void  SetMinDepth (float value);
    void  SetMaxDepth (float value);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Активность области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SetActive (bool active);
    bool IsActive  () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Порядок вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SetZOrder (int order);
    int  ZOrder    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Задний фон
///////////////////////////////////////////////////////////////////////////////////////////////////
    void               SetBackground   (bool state, const math::vec4f& color);
    bool               BackgroundState () const;
    const math::vec4f& BackgroundColor () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Техника отрисовки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetTechnique (const char* name);
    const char* Technique    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Свойства отрисовки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void                       SetProperties (const common::PropertyMap&);
    const common::PropertyMap& Properties    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Камера
///////////////////////////////////////////////////////////////////////////////////////////////////
         server::Camera* Camera ();
   const server::Camera* Camera () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сцена
///////////////////////////////////////////////////////////////////////////////////////////////////
   void                 SetScene (Scene* scene);
         server::Scene* Scene    ();
   const server::Scene* Scene    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Максимальный уровень вложенности рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   SetMaxDrawDepth (size_t level);
    size_t MaxDrawDepth    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Update (manager::Frame* parent_frame = 0);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление слушателей
///////////////////////////////////////////////////////////////////////////////////////////////////
    void AttachListener     (IViewportListener*);
    void DetachListener     (IViewportListener*);
    void DetachAllListeners ();

  private:
    struct Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Список отрисовываемых областей вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
class ViewportDrawList
{
  friend class Viewport;
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    ViewportDrawList  ();
    ViewportDrawList  (const ViewportDrawList&);
    ~ViewportDrawList ();

    ViewportDrawList& operator = (const ViewportDrawList&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка вспомогательных данных после отрисовки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void CleanupViewports ();

  private:
    struct Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер областей вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
class ViewportManager
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    ViewportManager  ();
    ViewportManager  (const ViewportManager&);
    ~ViewportManager ();

    ViewportManager& operator = (const ViewportManager&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    Viewport& GetViewport (object_id_t id);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание области вывода / удаление области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    void AddViewport    (object_id_t id, const Viewport& viewport);
    void RemoveViewport (object_id_t id);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Максимальный уровень вложенности рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   SetMaxDrawDepth (size_t level);
    size_t MaxDrawDepth    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Список областей вывода, в которые производилась отрисовка
///////////////////////////////////////////////////////////////////////////////////////////////////
    const ViewportDrawList& DrawingViewports () const;
          ViewportDrawList& DrawingViewports ();

  private:
    struct Impl;
    Impl* impl;
};

}

}

}

#endif
