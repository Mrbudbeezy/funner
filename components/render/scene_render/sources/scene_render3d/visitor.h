///////////////////////////////////////////////////////////////////////////////////////////////////
///Интерфейс диспетчера объектов при обходе сцены
///////////////////////////////////////////////////////////////////////////////////////////////////
class IVisitor
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Диспетчеризация по типам
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual void Visit (Node& entity) {}
    virtual void Visit (Renderable& entity) {}
    virtual void Visit (VisualModel& entity) {}
    virtual void Visit (Light& entity) {}

  protected:
    virtual ~IVisitor () {}
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Результаты обхода сцены
///////////////////////////////////////////////////////////////////////////////////////////////////
struct TraverseResult
{
  typedef stl::vector<Renderable*> RenderableArray;
  typedef stl::vector<Light*>      LightArray;
  
  RenderableArray renderables; //список отображаемых объектов
  LightArray      lights;      //список источников света  
  
///Очистка
  void Clear ()
  {
    lights.clear ();
    renderables.clear ();
  }
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Флаги для коллекционирующего диспетчера объектов
///////////////////////////////////////////////////////////////////////////////////////////////////
enum CollectionVisitorFilter
{
  Collect_Renderables = 1, //коллекционировать визуализируемые объекты
  Collect_Lights      = 2, //коллекционировать источники света

  Collect_All         = ~0u,
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Коллекционирующий диспетчер объектов
///////////////////////////////////////////////////////////////////////////////////////////////////
class CollectionVisitor: public IVisitor
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    CollectionVisitor (TraverseResult& results, size_t filter = Collect_All);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Диспетчеризация по типам
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Visit (Renderable& entity);
    void Visit (VisualModel& entity);
    void Visit (Light& entity);
    
  private:
    size_t          filter;
    TraverseResult& result; 
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Интерфейс кэша результата обхода сцены
///////////////////////////////////////////////////////////////////////////////////////////////////
class ITraverseResultCache
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение результата
///////////////////////////////////////////////////////////////////////////////////////////////////  
    virtual TraverseResult& Result () = 0;
  
  protected:
    virtual ~ITraverseResultCache () {}
};

