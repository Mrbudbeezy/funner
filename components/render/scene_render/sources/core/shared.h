#ifndef RENDER_SCENE_RENDER_CORE_SHARED_HEADER
#define RENDER_SCENE_RENDER_CORE_SHARED_HEADER

#include <stl/hash_map>
#include <stl/hash_set>
#include <stl/vector>
#include <stl/string>
#include <stl/algorithm>

#include <xtl/intrusive_ptr.h>
#include <xtl/shared_ptr.h>
#include <xtl/function.h>
#include <xtl/bind.h>
#include <xtl/iterator.h>
#include <xtl/reference_counter.h>
#include <xtl/common_exceptions.h>
#include <xtl/connection.h>

#include <common/singleton.h>
#include <common/strlib.h>
#include <common/component.h>

#include <sg/camera.h>

#include <render/mid_level/driver.h>

#include <render/manager.h>
#include <render/scene_render.h>

namespace render
{

typedef xtl::com_ptr<ICustomSceneRender> CustomSceneRenderPtr;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Реализация менеджера путей рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
class SceneRenderManagerImpl
{
  public:
    typedef SceneRenderManager::RenderCreater RenderCreater;
    typedef SceneRenderManager::Iterator      Iterator;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация путей рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    void RegisterRender       (const char* path_name, const RenderCreater& creater);
    void UnregisterRender     (const char* path_name);
    void UnregisterAllRenders ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Перебор путей рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    Iterator CreateIterator ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание рендера
///////////////////////////////////////////////////////////////////////////////////////////////////
    CustomSceneRenderPtr CreateRender (mid_level::IRenderer* renderer, const char* path_name);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение экземпляра менеджера
///////////////////////////////////////////////////////////////////////////////////////////////////
    static SceneRenderManagerImpl& Instance ();
    
  private:
    void LoadDefaultComponents ();

  private:
    class RenderPath;

    typedef xtl::intrusive_ptr<RenderPath>                           RenderPathPtr;
    typedef stl::hash_map<stl::hash_key<const char*>, RenderPathPtr> RenderPathMap;

  private:
    RenderPathMap paths; //карта путей рендеринга
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Контекст рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
class RenderContext: public IRenderContext
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    RenderContext (const Viewport&        viewport,
                   mid_level::IRenderer&  renderer,
                   const Rect&            window_rect,
                   bool                   need_clear,
                   const math::vec4f&     clear_color);
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Система рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    mid_level::IRenderer& Renderer ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя пути рендеринга
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* RenderPath ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Камера
///////////////////////////////////////////////////////////////////////////////////////////////////
    const scene_graph::Camera* Camera ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Преобразование области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    Rect TransformViewport (const Rect& client_rect);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Параметры очистки области вывода
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool               NeedClearViewport (); //нужно ли очищать область вывода
    const math::vec4f& ClearColor        (); //цвет очистки

///////////////////////////////////////////////////////////////////////////////////////////////////
///Чтение свойств
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* GetProperty (const char* name);
    bool        HasProperty (const char* name);

  private:
    const render::Viewport* viewport;
    mid_level::IRenderer*   renderer;
    bool                    need_clear;
    const math::vec4f*      clear_color;
    Rect                    window_rect;
};

}

#endif
