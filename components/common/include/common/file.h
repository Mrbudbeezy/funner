#ifndef COMMONLIB_FILE_SYSTEM_HEADER
#define COMMONLIB_FILE_SYSTEM_HEADER

#include <ctime>

#include <xtl/intrusive_ptr.h>
#include <xtl/functional_fwd>
#include <xtl/exception.h>

#include <stl/string_fwd>

namespace common
{

//implementation forwards
class FileImpl;
class FileList;
class FileListImpl;
class FileListBuilder;
class ICustomFileSystem;

//intrusive pointers
typedef xtl::intrusive_ptr<FileImpl>     FileImplPtr;
typedef xtl::intrusive_ptr<FileListImpl> FileListImplPtr;
typedef xtl::com_ptr<ICustomFileSystem>  ICustomFileSystemPtr;

/*
    Файловые исключения
*/

struct FileException:         virtual public xtl::exception {}; //тэг базового класса файловых исключений
struct FileNotFoundException:         public FileException {};  //файл не найден
struct FileNotDirException:           public FileException {};  //файл не является каталогом
struct FileLoadException:             public FileException {};  //ошибка загрузки файла
struct FileClosedException:           public FileException {};  //попытка обращения к закрытому файлу
struct FileNoSpaceException:          public FileException {};  //недостаточно места на носителе для завершения операции
struct FileMountException:            public FileException {};  //ошибка монтирования файловой системы
struct BufferedFileException:         public FileException {};  //исключения связанные с буферизацией файла

/*
    Основные структуры
*/

///////////////////////////////////////////////////////////////////////////////////////////////////
///Файловые атрибуты 
///////////////////////////////////////////////////////////////////////////////////////////////////
enum FileMode
{
  FileMode_Read        = 1,  //чтение разрешено
  FileMode_Write       = 2,  //запись разрешена
  FileMode_Resize      = 4,  //изменение размера разрешено
  FileMode_Rewind      = 8,  //сброс файлового указателя разрешён
  FileMode_Seek        = 16, //перемещение файлового указателя разрешено
  FileMode_Create      = 32, //при отсутствии файл создаётся, размер файла усекается
  FileMode_StreamRead  = FileMode_Read | FileMode_Rewind,                        //чтение потока
  FileMode_StreamWrite = FileMode_Write | FileMode_Rewind | FileMode_Resize,     //запись потока
  FileMode_ReadOnly    = FileMode_StreamRead | FileMode_Seek,                    //чтение файла произвольного доступа
  FileMode_WriteOnly   = FileMode_Create | FileMode_StreamWrite | FileMode_Seek, //запись файла произвольного доступа (сброс размера файла)
  FileMode_ReadWrite   = FileMode_ReadOnly | FileMode_StreamWrite,               //чтение/запись файла произвольного доступа
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Флаги поиска файла
///////////////////////////////////////////////////////////////////////////////////////////////////
enum FileSearch
{
  FileSearch_Files        = 1,  //искать файлы
  FileSearch_Dirs         = 2,  //искать каталоги
  FileSearch_Sort         = 4,  //отсортировать по имени
  FileSearch_NoPacks      = 8,  //не искать в паках
  FileSearch_SubDirs      = 16, //искать в подкаталогах
  FileSearch_FullPaths    = 32, //выводить полные пути
  FileSearch_FilesAndDirs = FileSearch_Files | FileSearch_Dirs
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Режим изменения файловой позиции
///////////////////////////////////////////////////////////////////////////////////////////////////
enum FileSeekMode
{
  FileSeekMode_Set,     //установка позиции от начала файла
  FileSeekMode_Current, //установка позиции от текущего положения файлового указателя
  FileSeekMode_End      //установка позиции от конца файла
};

typedef size_t filesize_t, filemode_t;
typedef time_t filetime_t;
typedef int    filepos_t;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Информация о файле
///////////////////////////////////////////////////////////////////////////////////////////////////
struct FileInfo
{
  filetime_t time_create;  //время создания файла
  filetime_t time_access;  //время последнего доступа к файлу
  filetime_t time_modify;  //время последней модификации файла
  filesize_t size;         //размер файла
  bool       is_dir;       //является ли файл директорией
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Хэш суммы содержимого файла
///////////////////////////////////////////////////////////////////////////////////////////////////
struct FileHash
{
  size_t        crc32;    //хэш-сумма CRC32
  unsigned char md5 [16]; //хэш-сумма MD5
};

/*
    Импортируемые интерфейсы файловой системы
*/

///////////////////////////////////////////////////////////////////////////////////////////////////
///Интерфейс пользовательской файловой системы
///////////////////////////////////////////////////////////////////////////////////////////////////
class ICustomFileSystem
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с файлом
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef void* file_t;

    virtual file_t     FileOpen   (const char* name,filemode_t mode_flags,size_t buffer_size) = 0;
    virtual void       FileClose  (file_t) = 0;
    virtual size_t     FileBufferSize (file_t) { return 0; } //ret (size_t)-1 - буферизация невозможна
    virtual size_t     FileRead   (file_t,void* buf,size_t size) = 0;
    virtual size_t     FileWrite  (file_t,const void* buf,size_t size) = 0;
    virtual void       FileRewind (file_t) = 0;
    virtual filepos_t  FileSeek   (file_t,filepos_t pos) = 0;
    virtual filepos_t  FileTell   (file_t) = 0;
    virtual filesize_t FileSize   (file_t) = 0;
    virtual void       FileResize (file_t,filesize_t new_size) = 0; 
    virtual bool       FileEof    (file_t) = 0;    
    virtual void       FileFlush  (file_t) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Управление расположением файлов
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual void Remove (const char* file_name) = 0;
    virtual void Rename (const char* file_name,const char* new_name) = 0;
    virtual void Mkdir  (const char* dir_name) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение информации о файле
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual bool IsFileExist (const char* file_name) = 0;
    virtual bool GetFileInfo (const char* file_name,FileInfo& info) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Поиск файла (Search возвращает количество найденных файлов)
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (const char* file, const FileInfo& info)> FileSearchHandler;

    virtual void Search (const char* wc_mask,const FileSearchHandler& handler) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Подсчёт ссылок
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual void AddRef  () = 0;
    virtual void Release () = 0;
    
  protected:
    virtual ~ICustomFileSystem () {}
};

/*
    Классы для работы с файлом
*/

///////////////////////////////////////////////////////////////////////////////////////////////////
///Файл
///////////////////////////////////////////////////////////////////////////////////////////////////
class File
{
  friend class FileSystem;
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктры / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    File  ();
    File  (const File&);
    ~File ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    File& operator = (const File&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Режим работы файла
///////////////////////////////////////////////////////////////////////////////////////////////////
    filemode_t Mode        () const;
    bool       CanRead     () const;
    bool       CanWrite    () const;
    bool       CanResize   () const;
    bool       CanSeek     () const;
    bool       CanRewind   () const;
    bool       IsReadOnly  () const;
    bool       IsWriteOnly () const;
    bool       IsClosed    () const;
    bool       IsBuffered  () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Чтение / запись
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Read  (void* buf,size_t size);
    size_t Write (const void* buf,size_t size);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Файловый указатель
///////////////////////////////////////////////////////////////////////////////////////////////////
    void      Rewind ();
    filepos_t Seek   (filepos_t pos,FileSeekMode mode = FileSeekMode_Set);
    filepos_t Tell   () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Размер файла / проверка на конец файла
///////////////////////////////////////////////////////////////////////////////////////////////////
    filesize_t Size   () const;
    void       Resize (filesize_t new_size); 
    bool       Eof    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сброс буферов на диск
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Flush ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Закрытие файла
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Close ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Сравнение двух файлов на эквивалентность
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool operator == (const File&) const;
    bool operator != (const File&) const;

  protected:
    File (FileImplPtr);

  private:
    FileImplPtr impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Стандартный именованный файл
///////////////////////////////////////////////////////////////////////////////////////////////////
class StdFile: public File
{
  public:
    StdFile (const char* file_name,filemode_t mode_flags);
    StdFile (const char* file_name,filemode_t mode_flags,size_t buffer_size);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Стандартный именованный файл для чтения
///////////////////////////////////////////////////////////////////////////////////////////////////
class InputFile: public StdFile
{
  public:
    explicit InputFile (const char* file_name);
             InputFile (const char* file_name,size_t buffer_size);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Стандартный именованный файл для записи
///////////////////////////////////////////////////////////////////////////////////////////////////
class OutputFile: public StdFile
{
  public:
    explicit OutputFile (const char* file_name);
             OutputFile (const char* file_name,size_t buffer_size);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Стандартный именованный файл для дозаписи
///////////////////////////////////////////////////////////////////////////////////////////////////
class AppendFile: public StdFile
{
  public:
    explicit AppendFile (const char* file_name);
             AppendFile (const char* file_name,size_t buffer_size);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Файл в памяти
///////////////////////////////////////////////////////////////////////////////////////////////////
class MemFile: public File
{
  public:
    MemFile (void* buf,size_t size,filemode_t mode_flags=FileMode_ReadWrite);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Пользовательский файл
///////////////////////////////////////////////////////////////////////////////////////////////////
class CustomFile: public File
{
  public:
    CustomFile (ICustomFileSystemPtr file_system,const char* file_name,filemode_t mode);
    CustomFile (ICustomFileSystemPtr      file_system,
                ICustomFileSystem::file_t handle,
                filemode_t                mode,
                bool                      auto_close = false);
};

/*
    Классы обслуживающие поиск файлов
*/

///////////////////////////////////////////////////////////////////////////////////////////////////
///Элемент списка файлов
///////////////////////////////////////////////////////////////////////////////////////////////////
struct FileListItem
{
  const char* name; //имя файла
  FileInfo    info; //информация о файле
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Итератор обхода списка файлов
///////////////////////////////////////////////////////////////////////////////////////////////////
class FileListIterator
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    FileListIterator  ();
    FileListIterator  (const FileList&);
    FileListIterator  (const FileListIterator&);
    ~FileListIterator ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    FileListIterator& operator = (const FileListIterator&);
    FileListIterator& operator = (const FileList&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Переход по файлам
///////////////////////////////////////////////////////////////////////////////////////////////////
    FileListIterator& operator ++ ();
    FileListIterator& operator -- ();
    FileListIterator  operator ++ (int);
    FileListIterator  operator -- (int);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение информации о файле
///////////////////////////////////////////////////////////////////////////////////////////////////
    const FileListItem* operator -> () const;
    const FileListItem& operator *  () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка корректности итератора
///////////////////////////////////////////////////////////////////////////////////////////////////
    operator bool () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Сравнение
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool operator == (const FileListIterator&) const;
    bool operator != (const FileListIterator&) const;
    bool operator <  (const FileListIterator&) const;
    bool operator >  (const FileListIterator&) const;
    bool operator <= (const FileListIterator&) const;
    bool operator >= (const FileListIterator&) const;          

  private:
    FileListImplPtr list_impl;
    size_t          pos;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Список файлов
///////////////////////////////////////////////////////////////////////////////////////////////////
class FileList
{
  friend class FileListIterator;
  friend class FileListBuilder;
  public:
    typedef FileListIterator Iterator;
    typedef FileListItem     ItemType;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктры / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    FileList  ();
    FileList  (const FileList&);
    ~FileList ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    FileList& operator = (const FileList&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество файлов / информация об i-м файле
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t          Size () const;
    const ItemType& Item (size_t index) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение итератора перебора списка
///////////////////////////////////////////////////////////////////////////////////////////////////
    Iterator GetIterator () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Сравнение двух списков на эквивалентность
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool operator == (const FileList&) const;
    bool operator != (const FileList&) const;

  private:
    FileList (FileListImpl*);

  private:
    FileListImplPtr impl;
};

/*
    Классы обеспечивающие управление файловой системой
*/

///////////////////////////////////////////////////////////////////////////////////////////////////
///Файловая система
///////////////////////////////////////////////////////////////////////////////////////////////////
class FileSystem
{
  public:
    typedef xtl::function<void (const char* message)>            LogHandler;
    typedef xtl::function<ICustomFileSystem* (const char* path)> PackFileCreater;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка текущего каталога
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void        SetCurrentDir (const char* path);
    static const char* GetCurrentDir ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление путей поиска
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void AddSearchPath        (const char* path);
    static void AddSearchPath        (const char* path,const LogHandler& log_handler);
    static void RemoveSearchPath     (const char* path);
    static void RemoveAllSearchPaths ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление / удаление пользовательских типов пак-файлов
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void RegisterPackFile   (const char* extension,const PackFileCreater& creater);
    static void UnregisterPackFile (const char* extension);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Монтирование пользовательской файловой системы
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void Mount       (const char* path_prefix,ICustomFileSystemPtr file_system);
    static void Unmount     (const char* path_prefix);
    static void Unmount     (ICustomFileSystemPtr file_system);
    static void UnmountAll  ();
    static bool IsPathMount (const char* path); //проверка: смонтирован ли путь

///////////////////////////////////////////////////////////////////////////////////////////////////
///Удаление / переименование файла, создание каталога
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void Remove (const char* file_name);
    static void Rename (const char* file_name,const char* new_name);
    static void Mkdir  (const char* dir_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Информация о файле
///////////////////////////////////////////////////////////////////////////////////////////////////
    static bool       GetFileInfo (const char* file_name,FileInfo& info);
    static bool       IsFileExist (const char* file_name);
    static bool       IsDir       (const char* file_name);
    static filetime_t GetFileTime (const char* file_name);
    static filesize_t GetFileSize (const char* file_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Рассчёт хэш сумм содержимого файла
///////////////////////////////////////////////////////////////////////////////////////////////////        
    static void GetFileHash (File& file,FileHash& out_hash_value);
    static void GetFileHash (const char* file_name,FileHash& out_hash_value);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Информация о файле
///////////////////////////////////////////////////////////////////////////////////////////////////
    static FileList Search (const char* wc_mask,size_t flags=FileSearch_FilesAndDirs);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка размера буфера файла по умолчанию
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void   SetDefaultFileBufferSize (size_t buffer_size);
    static size_t GetDefaultFileBufferSize ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Закрытие всех открытых файлов
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void CloseAllFiles ();    

///////////////////////////////////////////////////////////////////////////////////////////////////
///Приведение файлового имени к стандартному виду
///////////////////////////////////////////////////////////////////////////////////////////////////
    static stl::string GetNormalizedFileName (const char* file_name);
};

}

#endif
