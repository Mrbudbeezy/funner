#ifndef COMMONLIB_VAR_REGISTRY_HEADER
#define COMMONLIB_VAR_REGISTRY_HEADER

#include <xtl/any.h>
#include <xtl/functional_fwd>

namespace common
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///События реестра переменных
///////////////////////////////////////////////////////////////////////////////////////////////////
enum VarRegistryEvent
{
  VarRegistryEvent_OnCreateVar, //появление новой переменной
  VarRegistryEvent_OnDeleteVar, //удаление переменной
  VarRegistryEvent_OnChangeVar, //изменение значения переменной

  VarRegistryEvent_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Реестр переменных
///////////////////////////////////////////////////////////////////////////////////////////////////
class ICustomVarRegistry
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение/установка данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual xtl::any GetValue (const char* var_name) = 0;
    virtual void     SetValue (const char* var_name, const xtl::any& value) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка наличия переменной
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual bool HasVariable (const char* var_name) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обход всех переменных
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (const char* var_name)> EnumHandler;

    virtual void EnumerateVars (const EnumHandler& handler) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление/удаление ссылки
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual void AddRef () = 0;
    virtual void Release () = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Подписка на добавление/изменение/удаление переменных
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function <void (const char* var_name, VarRegistryEvent event)> EventHandler;

    virtual void                SetEventHandler (const EventHandler& handler) = 0;
    virtual const EventHandler& GetEventHandler () = 0;

  protected:
    virtual ~ICustomVarRegistry () {}
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обёртка над реестром переменных
///////////////////////////////////////////////////////////////////////////////////////////////////
class VarRegistry
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструкторы
///////////////////////////////////////////////////////////////////////////////////////////////////
    VarRegistry ();
    VarRegistry (const char* branch_name);
    VarRegistry (const VarRegistry& source);
    ~VarRegistry ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Копирование
///////////////////////////////////////////////////////////////////////////////////////////////////
    VarRegistry& operator = (const VarRegistry& source);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение/установка данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    xtl::any GetValue (const char* var_name) const;
    void     SetValue (const char* var_name, const xtl::any& value);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка наличия переменной
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool HasVariable (const char* var_name) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение имени
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* BranchName () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка подключен ли реестр
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool IsOpened () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Подключение/отключение реестра
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Open  (const char* branch_name);
    void Close ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обход всех переменных / переменных по маске
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef ICustomVarRegistry::EnumHandler EnumHandler;

    void EnumerateVars (const EnumHandler& handler);
    void EnumerateVars (const char* var_name_mask, const EnumHandler& handler);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Подписка на добавление/изменение/удаление переменных
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function <void (const char* var_name)> EventHandler;

    xtl::connection RegisterEventHandler (const char* var_name_mask, VarRegistryEvent event, const EventHandler& handler) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (VarRegistry& source);

  private:
    class Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (VarRegistry& source1, VarRegistry& source2);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Система реестров переменных
///////////////////////////////////////////////////////////////////////////////////////////////////
class VarRegistrySystem
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Созданеие/удаление ссылки
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void Link   (const char* link_name, const char* source);
    static void Unlink (const char* link_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присоединение/отсоединение реестра
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void Mount      (const char* branch_name, ICustomVarRegistry* registry);
    static void Unmount    (const char* branch_name, ICustomVarRegistry* registry);
    static void Unmount    (const char* branch_name);
    static void UnmountAll (ICustomVarRegistry* registry);
    static void UnmountAll ();
};

}

#endif
