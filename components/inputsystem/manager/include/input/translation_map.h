#ifndef INPUT_SYSTEM_TRANSLATION_MAP_HEADER
#define INPUT_SYSTEM_TRANSLATION_MAP_HEADER

#include <xtl/functional_fwd>

namespace input
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Таблица трансляции команд низкоуровневых устройств ввода в клиентские события
///////////////////////////////////////////////////////////////////////////////////////////////////
class TranslationMap
{
  public:
    struct Translation
    {
      const char* input_event;
      const char* client_event_replacement;
      const char* tag;

      Translation (const char* in_input_event, const char* in_client_event_replacement, const char* in_tag) : 
         input_event (in_input_event), client_event_replacement (in_client_event_replacement), tag (in_tag) {}
    };

    typedef xtl::function<void (const char* event)> EventHandler;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    TranslationMap  ();
    TranslationMap  (const char* file_name);
    TranslationMap  (const TranslationMap&);
    ~TranslationMap ();
    
    TranslationMap& operator = (const TranslationMap&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация трансляторов
///  (замены аргументов в клиентской подстановке через {1}, {2}, ...) 
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Add    (const char* input_event, const char* client_event_replacement);
    size_t Add    (const char* input_event, const char* client_event_replacement, const char* tag);
    void   Remove (const char* tag);
    void   Remove (size_t event_index);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Поиск транслятора по тэгу
///////////////////////////////////////////////////////////////////////////////////////////////////
    int FindTranslation (const char* tag) const; //return -1 if not found

///////////////////////////////////////////////////////////////////////////////////////////////////
///Перебор таблицы
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t      Size () const;
    Translation Item (size_t index) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка клиентского обработчика оттранслированных событий
///////////////////////////////////////////////////////////////////////////////////////////////////
    void                SetHandler (const EventHandler&);
    const EventHandler& Handler    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обработка события
///////////////////////////////////////////////////////////////////////////////////////////////////
    void ProcessEvent (const char* event) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Clear ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка / сохранение таблицы
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Load (const char* file_name);
    void Save (const char* file_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (TranslationMap&);

  private:
    struct Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (TranslationMap&, TranslationMap&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер таблиц трансляции
///////////////////////////////////////////////////////////////////////////////////////////////////
class TranslationMapManager
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с пользовательскими функциями загрузки и сохранения
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (const char* file_name,       TranslationMap&)> LoadHandler;
    typedef xtl::function<void (const char* file_name, const TranslationMap&)> SaveHandler;

    static void RegisterLoader       (const char* extension, const LoadHandler& handler);
    static void RegisterSaver        (const char* extension, const SaveHandler& handler);
    static void UnregisterLoader     (const char* extension);
    static void UnregisterSaver      (const char* extension);
    static void UnregisterAllLoaders ();
    static void UnregisterAllSavers  ();
    static void UnregisterAll        ();
};

}

#endif
