#ifndef MEDIALIB_RFX_COMMON_SHADER_HEADER
#define MEDIALIB_RFX_COMMON_SHADER_HEADER

#include <media/rfx/shader.h>
#include <media/rfx/texmap.h>
#include <mathlib.h>

namespace media
{

namespace rfx
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Уравнение смешивания цветов
///////////////////////////////////////////////////////////////////////////////////////////////////
enum BlendEquation
{
  BlendEquation_Add,                //arg1 + arg2
  BlendEquation_Subtraction,        //arg1 - arg2
  BlendEquation_ReverseSubtraction, //arg2 - arg1
  BlendEquation_Min,                //min (arg1, arg2)
  BlendEquation_Max,                //max (arg1, arg2)
  
  BlendEquation_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Аргумент смешивания цветов
///////////////////////////////////////////////////////////////////////////////////////////////////
enum BlendArgument
{
  BlendArgument_Zero,                    //0
  BlendArgument_One,                     //1
  BlendArgument_SourceColor,             //цвет источника
  BlendArgument_SourceAlpha,             //альфа источника
  BlendArgument_InverseSourceColor,      //1 - цвет источника
  BlendArgument_InverseSourceAlpha,      //1 - альфа источника
  BlendArgument_DestinationColor,        //цвет приёмника
  BlendArgument_DestinationAlpha,        //альфа приёмника
  BlendArgument_InverseDestinationColor, //1 - цвет приёмника
  BlendArgument_InverseDestinationAlpha, //1 - альфа приёмника
  
  BlendArgument_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Функция смешивания цветов
///////////////////////////////////////////////////////////////////////////////////////////////////
struct BlendFunction
{
  BlendEquation equation;     //уравнение смешивания цветов
  BlendArgument argument [2]; //аргументы
  
  BlendFunction (BlendEquation, BlendArgument, BlendArgument);
};

BlendFunction make_blend_filter   (); //src_color * src_alpha + dst_color * (1 - src_alpha)
BlendFunction make_blend_additive (); //src_color + dst_color
BlendFunction make_blend_solid    (); //src_color

///////////////////////////////////////////////////////////////////////////////////////////////////
///Функция сравнения
///////////////////////////////////////////////////////////////////////////////////////////////////
enum CompareMode
{
  CompareMode_AlwaysFail,   //результат сравнения всегда ложь
  CompareMode_AlwaysPass,   //результат сравнения всегда истина
  CompareMode_Equal,        //new_value == reference_value
  CompareMode_NotEqual,     //new_value != reference_value
  CompareMode_Less,         //new_value <  reference_value
  CompareMode_LessEqual,    //new_value <= reference_value
  CompareMode_Greater,      //new_value >  reference_value
  CompareMode_GreaterEqual, //new_value >= reference_value
  
  CompareMode_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип шейдера
///////////////////////////////////////////////////////////////////////////////////////////////////
enum CommonShaderType
{
  CommonShaderType_Flat,    //сплошная заливка
  CommonShaderType_Gourand, //заливка по Гуро
  CommonShaderType_Phong,   //заливка по Фонгу
  
  CommonShaderType_Default = CommonShaderType_Gourand,
  
  CommonShaderType_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Цвета слоя
///////////////////////////////////////////////////////////////////////////////////////////////////
enum CommonShaderColor
{
  CommonShaderColor_Ambient,   //цвет поглощения
  CommonShaderColor_Diffuse,   //цвет рассеивания
  CommonShaderColor_Specular,  //цвет отражения
  CommonShaderColor_Emission,  //цвет излучения 
  
  CommonShaderColor_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Текстурные карты, используемые шейдером
///////////////////////////////////////////////////////////////////////////////////////////////////
enum CommonShaderMap
{
  CommonShaderMap_Diffuse,     //базовая текстура (рассеянное освещение)
  CommonShaderMap_Ambient,     //текстура поглощения света
  CommonShaderMap_Specular,    //текстура степени отражения света
  CommonShaderMap_Transparent, //текстура прозрачности
  CommonShaderMap_Emission,    //текстура эмиссии (self-illumination)
  CommonShaderMap_Reflective,  //текстура карты отражения (env-map)
  CommonShaderMap_Bump,        //текстура рельефа поверхности

  CommonShaderMap_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Состояние карты
///////////////////////////////////////////////////////////////////////////////////////////////////
enum MapState
{
  MapState_Disabled, //карта запрещена
  MapState_Enabled   //карта разрешена
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проход по умолчанию
///////////////////////////////////////////////////////////////////////////////////////////////////
class CommonShader: public Shader
{
  public:
    typedef xtl::com_ptr<CommonShader>       Pointer;
    typedef xtl::com_ptr<const CommonShader> ConstPointer;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание
///////////////////////////////////////////////////////////////////////////////////////////////////
    static Pointer Create ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип шейдера
///////////////////////////////////////////////////////////////////////////////////////////////////
    CommonShaderType Type    () const;
    void             SetType (CommonShaderType);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Цвета
///////////////////////////////////////////////////////////////////////////////////////////////////
    const math::vec3f& Color    (CommonShaderColor color_id) const;
    void               SetColor (CommonShaderColor color_id, const math::vec3f& color);
    void               SetColor (CommonShaderColor color_id, float red, float green, float blue);

///////////////////////////////////////////////////////////////////////////////////////////////////
///"Металличность"
///////////////////////////////////////////////////////////////////////////////////////////////////
    float Shininess    () const;
    void  SetShininess (float value);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Прозрачность
///////////////////////////////////////////////////////////////////////////////////////////////////
    float Transparency    () const;
    void  SetTransparency (float value);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Настройка режима смешивания цветов
///////////////////////////////////////////////////////////////////////////////////////////////////
    const BlendFunction& Blend    () const;
    void                 SetBlend (const BlendFunction&);
    void                 SetBlend (BlendEquation equation, BlendArgument src_argument, BlendArgument dst_argument);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Настройка альфа-отсечения
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetAlphaTestMode      (CompareMode mode);
    void        SetAlphaTestReference (float alpha_reference);
    void        SetAlphaTest          (CompareMode mode, float alpha_reference);
    CompareMode AlphaTestMode         () const;
    float       AlphaTestReference    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Текстурные карты
///////////////////////////////////////////////////////////////////////////////////////////////////
    const Texmap& Map (CommonShaderMap map) const;
          Texmap& Map (CommonShaderMap map);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Веса текстурных карт
///////////////////////////////////////////////////////////////////////////////////////////////////
    float MapWeight    (CommonShaderMap map) const;
    void  SetMapWeight (CommonShaderMap map, float weight);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Разрешение / запрещение текстурных карт
///////////////////////////////////////////////////////////////////////////////////////////////////
    rfx::MapState MapState    (CommonShaderMap map) const;
    void          SetMapState (CommonShaderMap map, rfx::MapState state);

    bool IsMapEnabled (CommonShaderMap map) const { return MapState (map)  == MapState_Enabled; }
    void EnableMap    (CommonShaderMap map)       { SetMapState (map, MapState_Enabled);        }
    void DisableMap   (CommonShaderMap map)       { SetMapState (map, MapState_Disabled);       }

  protected:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    CommonShader  ();
    CommonShader  (const CommonShader&);
    ~CommonShader ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Динамическая диспетчеризация
///////////////////////////////////////////////////////////////////////////////////////////////////
    void AcceptCore (Visitor&);

  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Реализация копирования
///////////////////////////////////////////////////////////////////////////////////////////////////
    Shader* CloneCore () const;

  private:
    struct Impl;
    Impl* impl;
};

#include <media/rfx/detail/blend.inl>

}

}

#endif
