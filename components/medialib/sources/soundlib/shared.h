#ifndef __SOUNDLIB_SHARED__
#define __SOUNDLIB_SHARED__

#include <common/exception.h>
#include <common/singleton.h>
#include <stl/string>
#include <stl/hash_set>
#include <stl/hash_map>
#include <media/sound.h>

namespace medialib
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание реализации звукового сэмпла
///////////////////////////////////////////////////////////////////////////////////////////////////
class SoundSampleImpl
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Данные
///////////////////////////////////////////////////////////////////////////////////////////////////
    stl::string               str_name;  //SoundSample name
    SoundSampleInfo           info;      //Информация о файле
    stl::auto_ptr<SoundCodec> codec;     //Кодек
};

}

///////////////////////////////////////////////////////////////////////////////////////////////////
///Реализация звуковой системы
///////////////////////////////////////////////////////////////////////////////////////////////////
class SoundSampleSystemImpl
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    SoundSampleSystemImpl ();
    ~SoundSampleSystemImpl ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация открытых звуков / закрытие всех открытых звуков
///////////////////////////////////////////////////////////////////////////////////////////////////
    void RegisterSoundSample   (medialib::SoundSample&);
    void UnregisterSoundSample (medialib::SoundSample&);
    void CloseAllSoundSamples  ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка и вызов пользовательской функции лога дебаг-сообщений
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SetDebugLog (const design::function<void (const char*)>&);
    void DebugLog    (const char* debug_message);   

///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация и получение пользовательских функций загрузки и чтения звуков
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool           RegisterLoadFunc   (const char* extension, const medialib::SoundSampleSystem::CodecLoadFunc& load_codec);
    void           UnregisterLoadFunc (const char* extension);
    void           UnregisterAllFuncs ();
    medialib::SoundSampleSystem::CodecLoadFunc* GetLoadFunc(const char* extension);

  private:
    typedef stl::hash_set<medialib::SoundSample*>                            OpenSoundSamplesSet;
    typedef stl::hash_map<stl::string, medialib::SoundSampleSystem::CodecLoadFunc> LoadCodecs;

  private:    
    design::function<void (const char*)> log_function;         //польовательская функция дебаг-лога
    OpenSoundSamplesSet                  open_sound_samples;   //список открытых звуков
    LoadCodecs                           load_codecs;          //список пользовательских функций загрузки
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Синглтон звуковой системы
///////////////////////////////////////////////////////////////////////////////////////////////////
typedef common::Singleton<SoundSampleSystemImpl> SoundSystemSingleton;

#endif
