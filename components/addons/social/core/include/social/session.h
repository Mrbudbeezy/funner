#ifndef SOCIAL_SESSION_HEADER
#define SOCIAL_SESSION_HEADER

#include <cstddef>

#include <xtl/functional_fwd>

#include <social/achievement.h>
#include <social/common.h>
#include <social/leaderboard.h>
#include <social/user.h>

namespace common
{

//forward declaration
class PropertyMap;

}

namespace social
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сессия
///////////////////////////////////////////////////////////////////////////////////////////////////
class Session
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор / копирование
///////////////////////////////////////////////////////////////////////////////////////////////////
    Session (const char* session_name);
    Session (const Session& source);
    ~Session ();

    Session& operator = (const Session& source);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание сессии
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Description () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Логин
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LogIn          (const LoginCallback& callback, const common::PropertyMap& config);
    void LogOut         ();
    bool IsUserLoggedIn () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка произвольных запросов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void PerformRequest (const char* request, const RequestCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Показ стандартных окон
///////////////////////////////////////////////////////////////////////////////////////////////////
    void ShowWindow (const char* window_name, const WindowCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение залогиненного пользователя
///////////////////////////////////////////////////////////////////////////////////////////////////
          User& CurrentUser ();
    const User& CurrentUser () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка пользователя по идентификатору
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadUser (const char* id, const LoadUserCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Аватар
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadUserPicture (const User& user, const LoadUserPictureCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Друзья
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadFriendsIds (const User& user, const LoadFriendsIdsCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;
    void LoadFriends    (const User& user, const LoadFriendsCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Достижения
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadAchievements       (const LoadAchievementsCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;
    void LoadAchievementPicture (const Achievement& achievement, const LoadAchievementPictureCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;
    void SendAchievement        (const Achievement& achievement, const SendAchievementCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Таблицы рекордов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadLeaderboards (const LoadLeaderboardsCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;
    void LoadLeaderboard  (const char* leaderboard_id, const LoadLeaderboardCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;
    void LoadLeaderboard  (const char* leaderboard_id, const char* user_id, const LoadLeaderboardCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;
    void SendScore        (const Score& score, const SendScoreCallback& callback, const common::PropertyMap& properties = common::PropertyMap ()) const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (Session&);

  private:
    struct Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (Session&, Session&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер сессий
///////////////////////////////////////////////////////////////////////////////////////////////////
class SessionManager
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация создателей сессий
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<ISessionManager* (const char* session_name)> CreateSessionHandler;

    static void RegisterSession       (const char* id, const char* session_name_mask, const CreateSessionHandler& handler);
    static void UnregisterSession     (const char* id);
    static void UnregisterAllSessions ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка наличия сессии
///////////////////////////////////////////////////////////////////////////////////////////////////
    static bool IsSessionRegistered (const char* session_name);
};

}

#endif
