#ifndef STORE_STORE_HEADER
#define STORE_STORE_HEADER

#include <cstddef>

#include <store/common.h>
#include <store/product.h>
#include <store/transaction.h>

namespace store
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Магазин
///////////////////////////////////////////////////////////////////////////////////////////////////
class IStore
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual ~IStore () {}

///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание магазина
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual const char* GetDescription () = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Можно ли осуществлять покупки
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual bool CanBuyProducts () = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение информации о товарах (products_ids - разделенный пробелами список идентификаторов продуктов,
///products ответа может содержать не все запрошенные продукты)
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (const ProductList& products)> LoadProductsCallback;

    virtual void LoadProducts (const char* product_ids, const LoadProductsCallback& callback) = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Покупка / восстановление покупок
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (const Transaction&)> PurchaseCallback;

    virtual xtl::connection RegisterTransactionUpdateHandler (const PurchaseCallback&) = 0;
    virtual void            RestorePurchases                 () = 0;
    virtual Transaction     BuyProduct                       (const char* product_id, size_t count) = 0;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Магазин
///////////////////////////////////////////////////////////////////////////////////////////////////
class Store
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор / копирование
///////////////////////////////////////////////////////////////////////////////////////////////////
    Store (const char* store_name);
    Store (const Store& source);
    ~Store ();

    Store& operator = (const Store& source);

    void SetDataBasePath (const char* path) const; //???????????????

///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Description () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Можно ли осуществлять покупки
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool CanBuyProducts () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение информации о товарах (products_ids - разделенный пробелами список идентификаторов продуктов,
///products ответа может содержать не все запрошенные продукты)
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (const ProductList& products)> LoadProductsCallback;

    void LoadProducts (const char* product_ids, const LoadProductsCallback& callback) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Покупка / восстановление покупок
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<void (const Transaction&)> PurchaseCallback;
    
    xtl::connection RegisterTransactionUpdateHandler (const PurchaseCallback&);
    void            RestorePurchases                 () const;
    Transaction     BuyProduct                       (const char* product_id, size_t count, const PurchaseCallback& callback) const;  // нет никакой информации о транзакции??????
    Transaction     BuyProduct                       (const char* product_id, size_t count) const;
    bool            HasUnfinishedPurchases           () const; //???????????????

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (Store&);

  private:
    struct Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (Store&, Store&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер магазинов
///////////////////////////////////////////////////////////////////////////////////////////////////
class StoreManager
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация создателей сессий
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<IStore* (const char* store_name)> CreateStoreHandler;

    static void RegisterStore       (const char* id, const char* store_name_mask, const CreateStoreHandler& handler);
    static void UnregisterStore     (const char* id);
    static void UnregisterAllStores ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка наличия сессии
///////////////////////////////////////////////////////////////////////////////////////////////////
    static bool IsStoreRegistered (const char* store_name);
};


}

#endif
