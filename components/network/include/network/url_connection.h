#ifndef NETWORK_URL_CONNECTION_HEADER
#define NETWORK_URL_CONNECTION_HEADER

#include <xtl/functional_fwd>

#include <network/url.h>

namespace network
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Соединение для обмена URL ресурсами
///////////////////////////////////////////////////////////////////////////////////////////////////
class UrlConnection
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    UrlConnection  ();
    UrlConnection  (const network::Url&);
    UrlConnection  (const UrlConnection&);
    ~UrlConnection ();
    
    UrlConnection& operator = (const UrlConnection&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор ресурса
///////////////////////////////////////////////////////////////////////////////////////////////////
    const network::Url& Url () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Закрытие соединения
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Close    ();
    bool IsClosed () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Параметры содержимого
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t      ContentLength   () const;
    const char* ContentEncoding () const;
    const char* ContentType     () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Чтение / запись данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Receive (void* buffer, size_t size, size_t timeout_in_milliseconds = 0);
    size_t Send    (const void* buffer, size_t size, size_t timeout_in_milliseconds = 0);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Размеры окна приёма / передачи
///////////////////////////////////////////////////////////////////////////////////////////////////    
    size_t ReceiveAvailable () const; //количество байт доступных для чтения без блокировки
    size_t ReceivedDataSize () const; //общее число полученных байт
    size_t SendDataSize     () const; //общее число переданных байт

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (UrlConnection&);
  
  private:
    struct Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (UrlConnection&, UrlConnection&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Поток URL соединения
///////////////////////////////////////////////////////////////////////////////////////////////////
class IUrlStream
{
  public:
    virtual ~IUrlStream () {}
    
    virtual size_t      ContentLength   () = 0;
    virtual const char* ContentEncoding () = 0;
    virtual const char* ContentType     () = 0;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обработчик обратной связи потока URL соединения
///////////////////////////////////////////////////////////////////////////////////////////////////
class IUrlStreamCallback
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Обработка получения данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual void   WriteReceivedData (const void* buffer, size_t size) = 0;
    virtual size_t ReadSendData      (void* buffer, size_t size) = 0;

  protected:
    virtual ~IUrlStreamCallback () {}
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер URL запросов
///////////////////////////////////////////////////////////////////////////////////////////////////
class UrlQueryManager
{
  public:
    typedef xtl::function<IUrlStream* (const char* url, IUrlStreamCallback& stream)> ConnectionHandler;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация обработчиков URL запросов
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void RegisterQueryHandler       (const char* url_regexp, const ConnectionHandler& handler);
    static void UnregisterQueryHandler     (const char* url_regexp);
    static void UnregisterAllQueryHandlers ();
};

}

#endif
