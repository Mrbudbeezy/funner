#ifndef RENDER_GL_DRIVER_CONTEXT_OBJECT_HEADER
#define RENDER_GL_DRIVER_CONTEXT_OBJECT_HEADER

#include <shared/object.h>
#include <shared/context_manager.h>

#include <common/exception.h>

namespace render
{

namespace low_level
{

namespace opengl
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Контекстный объект
///////////////////////////////////////////////////////////////////////////////////////////////////
class ContextObject: public Object
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    ContextObject (const ContextManager&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка совместимости
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool IsCompatible (const ContextManager&) const;
    bool IsCompatible (const ContextObject&) const;  

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер контекстов
///////////////////////////////////////////////////////////////////////////////////////////////////
          ContextManager& GetContextManager ()       { return context_manager; }
    const ContextManager& GetContextManager () const { return context_manager; }

  protected:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Активация текущего контекста
///////////////////////////////////////////////////////////////////////////////////////////////////
    void MakeContextCurrent () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с таблицами локальных данных текущего контекста
///////////////////////////////////////////////////////////////////////////////////////////////////
    const ContextDataTable& GetContextDataTable (Stage table_id) const;
          ContextDataTable& GetContextDataTable (Stage table_id);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Определение поддержки расширения контекстом
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool IsSupported (size_t context_id, const Extension& extension) const;
    bool IsSupported (const Extension& extension) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Поулчение аппаратно поддерживаемых возможностей контекста
///////////////////////////////////////////////////////////////////////////////////////////////////
    const ContextCaps& GetCaps () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Протоколирование
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LogPrintf  (const char* format, ...) const;
    void LogVPrintf (const char* format, va_list args) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка ошибок OpenGL
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SetValidationState (bool state); //включение / отключение проверки ошибок
    bool GetValidationState () const;
    void CheckErrors        (const char* source) const;
    void RaiseError         (const char* source) const;
    void ClearErrors        () const;

  private:
    ContextManager context_manager;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Приведение типов объектов с проверкой совместимости
///////////////////////////////////////////////////////////////////////////////////////////////////
template <class DstT, class SrcT>
DstT* cast_object (const ContextManager& owner, SrcT* ptr, const char* source, const char* argument_name);

template <class DstT, class SrcT>
DstT* cast_object (const ContextObject& owner, SrcT* ptr, const char* source, const char* argument_name);

#include <shared/detail/context_object.inl>

}

}

}

#endif
