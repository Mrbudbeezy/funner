//forward declaration
ref class ApplicationServerImpl;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер плагинов
///////////////////////////////////////////////////////////////////////////////////////////////////
class PluginManager: public xtl::noncopyable
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор/деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    PluginManager (WindowSystem& window_system);
    ~PluginManager ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка/выгрузка плагинов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadPlugins   (const char* wc_mask);
    void UnloadPlugins (const char* wc_mask);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка конфигурации
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadConfiguration (System::Xml::XmlNode^ configuration);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание формы
///////////////////////////////////////////////////////////////////////////////////////////////////
    ChildForm::Pointer CreateForm (const char* plugin, const char* form_type);

  private:
    struct Plugin;

    typedef xtl::intrusive_ptr<Plugin>            PluginPtr;
    typedef stl::list<PluginPtr>                  PluginList;
    typedef msclr::gcroot<ApplicationServerImpl^> ApplicationServerPtr;

  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Предикат выгрузки плагина
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool UnloadPredicate (PluginPtr plugin, const char* wc_mask);

  private:
    WindowSystem*        window_system;      //оконная система
    common::Log          log;                //лог
    PluginList           plugins;            //загруженные плагины
    ApplicationServerPtr application_server; //интерфейс приложения
};
