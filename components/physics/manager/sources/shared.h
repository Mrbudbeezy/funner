#ifndef PHYSICS_MANAGER_SHARED_HEADER
#define PHYSICS_MANAGER_SHARED_HEADER

#include <xtl/bind.h>
#include <xtl/common_exceptions.h>
#include <xtl/connection.h>
#include <xtl/intrusive_ptr.h>
#include <xtl/iterator.h>
#include <xtl/reference_counter.h>
#include <xtl/trackable.h>

#include <stl/hash_map>
#include <stl/string>
#include <stl/vector>

#include <common/strlib.h>

#include <media/physics/basic_shapes.h>
#include <media/physics/compound.h>
#include <media/physics/physics_library.h>

#include <physics/low_level/driver.h>
#include <physics/low_level/joints.h>
#include <physics/low_level/material.h>
#include <physics/low_level/rigid_body.h>
#include <physics/low_level/scene.h>
#include <physics/low_level/shape.h>

#include <physics/manager.h>

namespace physics
{

typedef xtl::com_ptr<physics::low_level::IJoint>     JointPtr;
typedef xtl::com_ptr<physics::low_level::IRigidBody> RigidBodyPtr;
typedef xtl::com_ptr<physics::low_level::IScene>     ScenePtr;
typedef xtl::com_ptr<physics::low_level::IShape>     ShapePtr;
typedef stl::vector<RigidBody>                       RigidBodyArray;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Доступ к внутренним данным материала
///////////////////////////////////////////////////////////////////////////////////////////////////
class MaterialImplProvider
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание
///////////////////////////////////////////////////////////////////////////////////////////////////
    static Material CreateMaterial (physics::low_level::IDriver* driver);
    static Material CreateMaterial (physics::low_level::IDriver* driver, const media::physics::Material& material);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение низкоуровневого материала
///////////////////////////////////////////////////////////////////////////////////////////////////
    static physics::low_level::IMaterial* LowLevelMaterial (const Material& material);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Доступ к внутренним данным соединения тел
///////////////////////////////////////////////////////////////////////////////////////////////////
class JointImplProvider
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание
///////////////////////////////////////////////////////////////////////////////////////////////////
    static Joint CreateJoint (JointPtr joint, const RigidBodyArray& bodies);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Доступ к внутренним данным физической сцены
///////////////////////////////////////////////////////////////////////////////////////////////////
class SceneImplProvider
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание
///////////////////////////////////////////////////////////////////////////////////////////////////
    static Scene CreateScene (physics::low_level::IDriver* driver, ScenePtr scene, const media::physics::PhysicsLibrary::RigidBodyCollection& body_collection);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Доступ к внутренним данным геометрического тела
///////////////////////////////////////////////////////////////////////////////////////////////////
class ShapeImplProvider
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание
///////////////////////////////////////////////////////////////////////////////////////////////////
    static Shape CreateShape (ShapePtr shape);
    static Shape CreateShape (ShapePtr shape, const ShapeList& shape_list);
    static Shape CreateShape (physics::low_level::IDriver* driver, const media::physics::Shape& shape);
    static Shape CreateShape (physics::low_level::IDriver* driver, const ShapeList& shape_list);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение низкоуровневого тела
///////////////////////////////////////////////////////////////////////////////////////////////////
    static physics::low_level::IShape* LowLevelShape (const Shape& shape);

  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание
///////////////////////////////////////////////////////////////////////////////////////////////////
    static Shape CreateShapeCore     (physics::low_level::IDriver* driver, const media::physics::Shape& shape);
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Реализация твердого тела
///////////////////////////////////////////////////////////////////////////////////////////////////
class RigidBodyImpl : public xtl::reference_counter, public xtl::trackable
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    RigidBodyImpl (RigidBodyPtr in_body, const physics::Shape& in_shape, const physics::Material& in_material);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение текущей позиции
///////////////////////////////////////////////////////////////////////////////////////////////////
    const Transform& CurrentTransform ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обработка изменения позиции
///////////////////////////////////////////////////////////////////////////////////////////////////
    void OnTransformUpdate ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Геометрическое тело
///////////////////////////////////////////////////////////////////////////////////////////////////
    physics::Shape& Shape ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Материал
///////////////////////////////////////////////////////////////////////////////////////////////////
    physics::Material& Material    ();
    void               SetMaterial (const physics::Material& material);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение низкоуровневого тела
///////////////////////////////////////////////////////////////////////////////////////////////////
    physics::low_level::IRigidBody* LowLevelBody ();

  private:
    RigidBodyPtr         body;
    physics::Shape       shape;
    physics::Material    material;
    Transform            current_transform;
    xtl::auto_connection transform_update_connection;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Доступ к внутренним данным твердого тела
///////////////////////////////////////////////////////////////////////////////////////////////////
class RigidBodyImplProvider
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание
///////////////////////////////////////////////////////////////////////////////////////////////////
    static RigidBody CreateRigidBody (RigidBodyPtr body, const Shape& shape, const Material& material);
    static RigidBody CreateRigidBody (RigidBodyImpl* impl);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение реализации
///////////////////////////////////////////////////////////////////////////////////////////////////
    static RigidBodyImpl* Impl (const RigidBody& body);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение низкоуровневого тела
///////////////////////////////////////////////////////////////////////////////////////////////////
    static physics::low_level::IRigidBody* LowLevelBody (const RigidBody& body);
};

}

#endif
