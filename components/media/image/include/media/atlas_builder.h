#ifndef MEDIALIB_ATLAS_BUILDER_HEADER
#define MEDIALIB_ATLAS_BUILDER_HEADER

#include <xtl/functional_fwd>

#include <media/atlas.h>

namespace media
{

//forward declaration
class Image;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Режим вставки изображений в построитель атласа
///////////////////////////////////////////////////////////////////////////////////////////////////
enum AtlasBuilderInsertMode
{
  AtlasBuilderInsertMode_Copy,    //копирование изображения при вставке
  AtlasBuilderInsertMode_Capture, //захват изображения при вставке
  
  AtlasBuilderInsertMode_Default = AtlasBuilderInsertMode_Copy,
  
  AtlasBuilderInsertMode_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Режим увеличения сторон во время построения атласа
///////////////////////////////////////////////////////////////////////////////////////////////////
enum AtlasPackFlag
{
  AtlasPackFlag_PowerOfTwoEdges = 1, //стороны степени двойки
  AtlasPackFlag_InvertTilesX    = 2, //инвертировать расположение тайлов по оси X
  AtlasPackFlag_InvertTilesY    = 4, //инвертировать расположение тайлов по оси Y
  AtlasPackFlag_SwapAxises      = 8, //изменить расположение осей при размещении тайлов
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Построитель атласа изображений
///////////////////////////////////////////////////////////////////////////////////////////////////
class AtlasBuilder
{
  public:
    typedef xtl::function<void (size_t images_count, const math::vec2ui* in_sizes, math::vec2ui* out_origins, size_t pack_flags)> PackHandler;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    AtlasBuilder  (const char* pack_handler_name = "default");
    AtlasBuilder  (const PackHandler&);
    ~AtlasBuilder ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка имени атласной картинки (полной)
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetAtlasImageName (const char* name);
    const char* AtlasImageName    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление изображений
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Insert (media::Image&, AtlasBuilderInsertMode mode = AtlasBuilderInsertMode_Default);
    void Insert (const char* image_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сброс
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Reset ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Построение карты
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Build (media::Atlas& out_atlas, media::Image& out_atlas_image, size_t pack_flags);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (AtlasBuilder&);

  private:
    AtlasBuilder (const AtlasBuilder&); //no impl
    AtlasBuilder& operator = (const AtlasBuilder&); //no impl

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (AtlasBuilder&, AtlasBuilder&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер построителей атласа изображений
///////////////////////////////////////////////////////////////////////////////////////////////////
class AtlasBuilderManager
{
  public:
    typedef AtlasBuilder::PackHandler PackHandler;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение упаковщика атласа
///////////////////////////////////////////////////////////////////////////////////////////////////
    static const PackHandler& GetPacker (const char* name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация упаковщиков атласа
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void RegisterPacker       (const char* name, const PackHandler& handler);
    static void UnregisterPacker     (const char* name);
    static void UnregisterAllPackers ();
};

}

#endif
