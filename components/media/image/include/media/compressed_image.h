#ifndef MEDIALIB_COMPRESSED_IMAGE_HEADER
#define MEDIALIB_COMPRESSED_IMAGE_HEADER

#include <cstddef>

#include <common/serializer_manager.h>

namespace media
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Описание блока данных карты сжатой картинки
///////////////////////////////////////////////////////////////////////////////////////////////////
struct CompressedImageBlockDesc
{
  size_t offset; //смещение от начала буфера данных
  size_t size;   //размер блока в байтах
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сжатая картинка
///////////////////////////////////////////////////////////////////////////////////////////////////
class CompressedImage
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    CompressedImage  ();
    CompressedImage  (const char* file_name);
    CompressedImage  (const CompressedImage&);
    ~CompressedImage ();

    CompressedImage& operator = (const CompressedImage&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Размеры картинки в пикселях
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Width    () const;
    size_t Height   () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество слоёв / mip-уровней / блоков
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t LayersCount () const;
    size_t MipsCount   () const;
    size_t BlocksCount () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Формат - платформо-зависим, предполагается непосредственная загрузка сжатых образов в видеопамять
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Format () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    const void*                     Data   () const;
    const CompressedImageBlockDesc* Blocks () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение битовой карты
///////////////////////////////////////////////////////////////////////////////////////////////////
    const void* Bitmap     (size_t layer, size_t mip_level) const;
    size_t      BitmapSize (size_t layer, size_t mip_level) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Load (const char* file_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (CompressedImage&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация сериализаторов по умолчанию
///////////////////////////////////////////////////////////////////////////////////////////////////
    static void RegisterDefaultLoaders ();    

  private:
    struct Impl;
    Impl* impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (CompressedImage&, CompressedImage&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Интерфейс реализации сжатой картинки
///////////////////////////////////////////////////////////////////////////////////////////////////
class ICustomCompressedImage
{
  public:
    virtual ~ICustomCompressedImage () {}

///////////////////////////////////////////////////////////////////////////////////////////////////
///Информация о картинке
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual size_t      Width       () = 0;
    virtual size_t      Height      () = 0;
    virtual size_t      LayersCount () = 0;
    virtual size_t      MipsCount   () = 0;
    virtual const char* Format      () = 0;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual const void*                     Data   () = 0;
    virtual const CompressedImageBlockDesc* Blocks () = 0;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Система управления картинками
///////////////////////////////////////////////////////////////////////////////////////////////////
typedef common::ResourceSerializerManager<ICustomCompressedImage* (const char* file_name), void ()> CompressedImageManager;

}

#endif
