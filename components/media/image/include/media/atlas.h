#ifndef MEDIALIB_IMAGEMAP_HEADER
#define MEDIALIB_IMAGEMAP_HEADER

#include <stl/auto_ptr.h>

#include <xtl/functional_fwd>

#include <common/serializer_manager.h>

#include <mathlib.h>

namespace media
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Элемент карты картинок
///////////////////////////////////////////////////////////////////////////////////////////////////
struct Tile
{
  const char*  name;
  math::vec2ui origin;
  math::vec2ui size;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Карта картинок
///////////////////////////////////////////////////////////////////////////////////////////////////
class Atlas
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    Atlas  ();
    Atlas  (const char* file_name);
    Atlas  (const Atlas&);
    ~Atlas ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    Atlas& operator = (const Atlas&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка/получение имени картинки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetImage (const char* image);
    const char* Image    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t TilesCount () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Поиск
///////////////////////////////////////////////////////////////////////////////////////////////////
    const media::Tile* Find (const char* name) const; //no throw

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение тайла
///////////////////////////////////////////////////////////////////////////////////////////////////
    const media::Tile& Tile (size_t index) const;
    const media::Tile& Tile (const char* name) const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление тайла
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Insert (const media::Tile& new_tile);
    size_t Insert (const char* name, const math::vec2ui& origin, const math::vec2ui& size);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Изменение тайла
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Set (size_t tile_index, const media::Tile& new_tile);
    void Set (size_t tile_index, const char* name, const math::vec2ui& origin, const math::vec2ui& size);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Удаление тайла
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Remove         (size_t tile_index);
    void Remove         (const char* name);
    void RemoveAllTiles ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка / сохранение
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Load (const char* file_name);
    void Save (const char* file_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (Atlas&);
  
  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (Atlas&, Atlas&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Система управления картами картинок
///////////////////////////////////////////////////////////////////////////////////////////////////
typedef common::ResourceSerializerManager<void (const char* file_name, Atlas& image_map), void (const char* file_name, const Atlas& image_map)> AtlasManager;

}

#endif
