#ifndef MEDIALIB_FONT_HEADER
#define MEDIALIB_FONT_HEADER

#include <cstdlib>

#include <media/image.h>

namespace xtl
{

//forward declaration
class trackable;

}

namespace media
{

//forward declarations
class FontBuilder;
class FontImpl;
class IFontRasterizer;
class RasterizedFont;

//////////////////////////////////////////////////////////////////////////////////////////////////
///Информация о глифе
//////////////////////////////////////////////////////////////////////////////////////////////////
struct GlyphInfo
{
  float  width;      //Ширина глифа
  float  height;     //Высота глифа
  float  bearing_x;  //Расстояние от положения пера до левой границы буквы
  float  bearing_y;  //Расстояние от положения пера до верхней границы буквы
  float  advance_x;  //Отступ по оси X от текущего положения пера до следующего положения пера
  float  advance_y;  //Отступ по оси Y от текущего положения пера до следующего положения пера
};

//////////////////////////////////////////////////////////////////////////////////////////////////
///Информация о уменьшенных межзнаковых интервалах
//////////////////////////////////////////////////////////////////////////////////////////////////
struct KerningInfo
{
  float x_kerning;   //Отступ по оси X от положения пера для отображения левого глифа до положения пера для отображения правого глифа
  float y_kerning;   //Отступ по оси Y от положения пера для отображения левого глифа до положения пера для отображения правого глифа
};

//////////////////////////////////////////////////////////////////////////////////////////////////
///Параметры создания растеризованного шрифта
//////////////////////////////////////////////////////////////////////////////////////////////////
struct RasterizedFontCreationParams
{
  unsigned int       max_image_size;  //максимальный размер стороны картинки
  bool               pot;             //должен ли размер стороны картинки иметь степень двойки
  unsigned int       glyph_margin;    //отступ между символами в картинке
  media::PixelFormat image_format;    //формат картинки
};

//////////////////////////////////////////////////////////////////////////////////////////////////
///Гарнитура
//////////////////////////////////////////////////////////////////////////////////////////////////
class Font
{
  friend class FontBuilder;

  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор/деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    Font  (const Font& source);
    ~Font ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    Font& operator = (const Font&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя файла
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Source () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Id () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя гарнитуры / имя семейства / имя стиля
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name       () const;
    const char* FamilyName () const;
    const char* StyleName  () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Размер таблицы глифов
///////////////////////////////////////////////////////////////////////////////////////////////////
    unsigned int GlyphsCount () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Код первого глифа
///////////////////////////////////////////////////////////////////////////////////////////////////
    unsigned int FirstGlyphCode () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Размер шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    unsigned int FontSize () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Доступ к данным о глифах
///////////////////////////////////////////////////////////////////////////////////////////////////
    const GlyphInfo* Glyphs () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Информация о кёрнингах
///////////////////////////////////////////////////////////////////////////////////////////////////
    KerningInfo Kerning    (unsigned int left_glyph_index, unsigned int right_glyph_index) const;
    bool        HasKerning (unsigned int left_glyph_index, unsigned int right_glyph_index) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание растеризованного шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    RasterizedFont CreateRasterizedFont (const RasterizedFontCreationParams&) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение объекта-события оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
    xtl::trackable& GetTrackable () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (Font&);

  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    Font (FontImpl*);

  private:
    FontImpl* impl;
};

//////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
//////////////////////////////////////////////////////////////////////////////////////////////////
void swap (Font&, Font&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение объекта-события оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
xtl::trackable& get_trackable (const Font&);

//////////////////////////////////////////////////////////////////////////////////////////////////
///Построитель шрифта
//////////////////////////////////////////////////////////////////////////////////////////////////
class FontBuilder
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор/деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
   FontBuilder  ();
   FontBuilder  (const FontBuilder& source);
   ~FontBuilder ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    FontBuilder& operator = (const FontBuilder&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение / изменение имени исходного файла
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Source    () const;
    void        SetSource (const char* new_source);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение/изменение имени / семейства / стиля шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name          () const;
    const char* FamilyName    () const;
    const char* StyleName     () const;
    void        Rename        (const char* new_name);
    void        SetFamilyName (const char* new_family_name);
    void        SetStyleName  (const char* new_style_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение/изменение размера таблицы глифов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void         SetGlyphsCount (unsigned int new_glyphs_count);
    unsigned int GlyphsCount    () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение/изменение кода первого глифа
///////////////////////////////////////////////////////////////////////////////////////////////////
    void         SetFirstGlyphCode (unsigned int new_first_glyph_code);
    unsigned int FirstGlyphCode    () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение/изменение размера шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    void         SetFontSize (unsigned int new_font_size);
    unsigned int FontSize    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Доступ к данным о глифах
///////////////////////////////////////////////////////////////////////////////////////////////////
    const GlyphInfo* Glyphs () const;
          GlyphInfo* Glyphs ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Добавление/получение/удаление информации о кёрнингах
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        InsertKerning     (unsigned int left_glyph_index, unsigned int right_glyph_index, const KerningInfo& kerning_info);
    void        RemoveKerning     (unsigned int left_glyph_index, unsigned int right_glyph_index);
    void        RemoveAllKernings ();
    KerningInfo Kerning           (unsigned int left_glyph_index, unsigned int right_glyph_index) const;
    bool        HasKerning        (unsigned int left_glyph_index, unsigned int right_glyph_index) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Установка растеризатора
///////////////////////////////////////////////////////////////////////////////////////////////////
    typedef xtl::function<IFontRasterizer* (const RasterizedFontCreationParams&)> RasterizerHandler;

    void                     SetRasterizer (const RasterizerHandler&);
    const RasterizerHandler& Rasterizer    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    media::Font Font ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (FontBuilder&);

  private:
    struct Impl;
    Impl* impl;
};

//////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
//////////////////////////////////////////////////////////////////////////////////////////////////
void swap (FontBuilder&, FontBuilder&);

}

#endif
