#ifndef MEDIALIB_VIDEO_HEADER
#define MEDIALIB_VIDEO_HEADER

#include <cstddef>

#include <stl/auto_ptr.h>

#include <xtl/functional_fwd>

#include <common/serializer_manager.h>

namespace media
{

//forward declarations
class Image;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Качество декодирования видео
///////////////////////////////////////////////////////////////////////////////////////////////////
enum VideoQuality
{
  VideoQuality_Low,
  VideoQuality_Middle,
  VideoQuality_High,
  
  VideoQuality_Default = VideoQuality_High,
  
  VideoQuality_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Интерфейс декодера видео
///////////////////////////////////////////////////////////////////////////////////////////////////
class IVideoDecoder
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Формат пикселей декодированного видео
///////////////////////////////////////////////////////////////////////////////////////////////////
    struct Pixel
    {
      unsigned char red, green, blue, alpha;
    };
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Операции
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual              ~IVideoDecoder      () {}    //деструктор
    virtual float        GetFramesPerSecond  () = 0;  //количество кадров в секунду
    virtual unsigned int GetWidth            () = 0;  //ширина изображения декодированного видео
    virtual unsigned int GetHeight           () = 0;  //высота изображения декодированного видео
    virtual unsigned int GetFramesCount      () = 0;  //количество кадров в видео
    virtual float        GetPixelAspectRatio () = 0;  //соотношение сторон для каждого пикселя (x / y)
    virtual void         Decode              (unsigned int frame, Pixel* data_buffer) = 0; //декодирование указанного кадра
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Видео поток
///////////////////////////////////////////////////////////////////////////////////////////////////
class VideoStream
{
  public:
    typedef IVideoDecoder::Pixel Pixel;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    VideoStream  ();
    VideoStream  (const char* file_name, VideoQuality quality = VideoQuality_Default);
    VideoStream  (const VideoStream&);
    ~VideoStream ();

    VideoStream& operator = (const VideoStream&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя потока
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name   () const;
    void        Rename (const char* new_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение параметров видео
///////////////////////////////////////////////////////////////////////////////////////////////////
    VideoQuality Quality          () const; //качество декодирования видео
    unsigned int FramesCount      () const; //количество кадров
    float        FramesPerSecond  () const; //количество кадров в секунду
    unsigned int Width            () const; //ширина кадра
    unsigned int Height           () const; //высота кадра
    float        PixelAspectRatio () const; //соотношение сторон для каждого пикселя (x / y)
    float        Duration         () const; //длительность видео в секундах
    unsigned int FrameSize        () const; //размер кадра в байтах
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение декодированного кадра
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Decode (unsigned int frame_number, Image& image, unsigned int image_offset_x = 0, unsigned int image_offset_y = 0, unsigned int image_offset_z = 0);
    void Decode (unsigned int frame_number, Pixel* frame_buffer);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка видео
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Load (const char* file_name, VideoQuality quality = VideoQuality_Default);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (VideoStream&);

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (VideoStream&, VideoStream&);

//////////////////////////////////////////////////////////////////////////////////////////////////
///Система управления видео потоками
//////////////////////////////////////////////////////////////////////////////////////////////////
typedef common::ResourceSerializerManager<IVideoDecoder* (const char* file_name, VideoQuality quality),
  void (const char* file_name, VideoStream&)> VideoStreamManager;

}

#endif
