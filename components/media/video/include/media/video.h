#ifndef MEDIALIB_VIDEO_HEADER
#define MEDIALIB_VIDEO_HEADER

#include <cstddef>

#include <xtl/functional_fwd>

#include <common/serializer_manager.h>

namespace media
{

//forward declarations
class Image;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Качество декодирования видео
///////////////////////////////////////////////////////////////////////////////////////////////////
enum VideoQuality
{
  VideoQuality_Low,
  VideoQuality_Middle,
  VideoQuality_High,
  
  VideoQuality_Default = VideoQuality_High,
  
  VideoQuality_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Интерфейс декодера видео
///////////////////////////////////////////////////////////////////////////////////////////////////
class IVideoDecoder
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Формат пикселей декодированного видео
///////////////////////////////////////////////////////////////////////////////////////////////////
    struct Pixel
    {
      unsigned char red, green, blue, alpha;
    };
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Операции
///////////////////////////////////////////////////////////////////////////////////////////////////
    virtual        ~IVideoDecoder      () {}    //деструктор
    virtual size_t GetFramesPerSecond  () = 0;  //количество кадров в секунду
    virtual size_t GetWidth            () = 0;  //ширина изображения декодированного видео
    virtual size_t GetHeight           () = 0;  //высота изображения декодированного видео
    virtual size_t GetFramesCount      () = 0;  //количество кадров в видео
    virtual float  GetPixelAspectRatio () = 0;  //соотношение сторон для каждого пикселя (x / y)
    virtual void   Decode              (size_t frame, Pixel* data_buffer) = 0; //декодирование указанного кадра
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Видео поток
///////////////////////////////////////////////////////////////////////////////////////////////////
class VideoStream
{
  public:
    typedef IVideoDecoder::Pixel Pixel;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    VideoStream  ();
    VideoStream  (const char* file_name, VideoQuality quality = VideoQuality_Default);
    VideoStream  (const Video&);
    ~VideoStream ();

    VideoStream& operator = (const Video&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя потока
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name   () const;
    void        Rename (const char* new_name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение параметров видео
///////////////////////////////////////////////////////////////////////////////////////////////////
    VideoQuality Quality          () const;
    size_t       FramesPerSecond  () const;
    size_t       Width            () const;
    size_t       Height           () const;
    float        PixelAspectRatio () const;
    float        Duration         () const;
    size_t       FrameSize        () const;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение декодированного кадра
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Decode (size_t frame_number, Image& image, size_t image_offset_x = 0, size_t image_offset_y = 0);
    void Decode (size_t frame_number, Pixel* frame_buffer);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка видео
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Load (const char* file_name, VideoQuality quality = VideoQuality_Default);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (VideoStream&);

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (VideoStream&, VideoStream&);

//////////////////////////////////////////////////////////////////////////////////////////////////
///Система управления видео потоками
//////////////////////////////////////////////////////////////////////////////////////////////////
typedef common::ResourceSerializerManager<IVideoDecoder* (const char* file_name, VideoQuality quality)> VideoStreamManager;

}

#endif
