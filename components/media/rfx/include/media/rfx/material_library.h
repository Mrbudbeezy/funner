#ifndef MEDIALIB_RFX_MATERIAL_LIBRARY_HEADER
#define MEDIALIB_RFX_MATERIAL_LIBRARY_HEADER

#include <media/rfx/material.h>
#include <common/serializer_manager.h>

namespace xtl
{

//forward decalration
template <class T> class iterator;

}

namespace media
{

namespace rfx
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Библиотека материалов
///////////////////////////////////////////////////////////////////////////////////////////////////
class MaterialLibrary
{
  public:
    typedef xtl::iterator<Material::Pointer>      Iterator, ConstIterator; //исправить после доработки итератора
//    typedef xtl::iterator<Material::ConstPointer> ConstIterator;
    typedef xtl::function<void (const char* message)> LogHandler;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    MaterialLibrary  ();
    MaterialLibrary  (const char* file_name);
    MaterialLibrary  (const char* file_name, const LogHandler& log_handler);
    MaterialLibrary  (const MaterialLibrary&);
    ~MaterialLibrary ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    MaterialLibrary& operator = (const MaterialLibrary&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя библиотеки
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name   () const;
    void        Rename (const char* name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество материалов в библиотеке / проверка на пустоту
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Size    () const;
    bool   IsEmpty () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение итератора
///////////////////////////////////////////////////////////////////////////////////////////////////
    Iterator      CreateIterator ();
    ConstIterator CreateIterator () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение идентификатора материала
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* ItemId (const ConstIterator&) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Поиск
///////////////////////////////////////////////////////////////////////////////////////////////////
    Material::Pointer      Find (const char* name);
    Material::ConstPointer Find (const char* name) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присоединение материалов
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Attach    (const char* id, const Material::Pointer& material_ptr);
    void Detach    (const char* id); //no throw
    void DetachAll ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка библиотеки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Clear ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка / сохранение
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Load (const char* file_name);
    void Load (const char* file_name, const LogHandler& log);
    void Save (const char* file_name);
    void Save (const char* file_name, const LogHandler& log);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (MaterialLibrary&);
  
  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (MaterialLibrary&, MaterialLibrary&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер библиотек материалов
///////////////////////////////////////////////////////////////////////////////////////////////////
typedef common::ResourceSerializerManager
<
  void (const char* file_name, MaterialLibrary& library, const MaterialLibrary::LogHandler& log_handler),
  void (const char* file_name, const MaterialLibrary& library, const MaterialLibrary::LogHandler& log_handler)
> MaterialLibraryManager;

}

}

#endif
